{"version":3,"file":"index.js","names":["fs","Client","DefaultAMOClient","signAddon","xpiPath","id","version","apiKey","apiSecret","apiUrlPrefix","apiJwtExpiresIn","verbose","channel","timeout","downloadDir","apiProxy","apiRequestConfig","disableProgressBar","AMOClient","reportEmpty","name","Error","stats","stat","isFile","statError","client","debugLogging","statusCheckTimeout","proxyServer","requestConfig","sign","guid","signAddonAndExit","options","systemProcess","process","throwError","logger","console","result","log","success","exit","err","error","stack"],"sources":["../src/index.js"],"sourcesContent":["import { fs } from 'mz';\n\nimport { Client as DefaultAMOClient } from './amo-client.js';\n\n/** @typedef {import(\"request\").OptionsWithUrl} RequestConfig */\n/** @typedef {import(\"./amo-client.js\").ClientParams} ClientParams */\n/** @typedef {import(\"./amo-client.js\").ReleaseChannel} ReleaseChannel */\n\n/**\n * @typedef {object} SignAddonParams\n * @property {string} xpiPath\n * @property {string} id\n * @property {string} version\n * @property {ClientParams['apiKey']} apiKey\n * @property {ClientParams['apiSecret']} apiSecret\n * @property {ClientParams['apiUrlPrefix']=} apiUrlPrefix\n * @property {ClientParams['apiJwtExpiresIn']=} apiJwtExpiresIn\n * @property {ClientParams['debugLogging']=} verbose\n * @property {ReleaseChannel=} channel\n * @property {ClientParams['statusCheckTimeout']=} timeout\n * @property {ClientParams['downloadDir']=} downloadDir\n * @property {ClientParams['proxyServer']=} apiProxy\n * @property {ClientParams['requestConfig']=} apiRequestConfig\n * @property {typeof DefaultAMOClient=} AMOClient\n * @property {ClientParams['disableProgressBar']=} disableProgressBar\n *\n * @param {SignAddonParams} params\n */\nexport const signAddon = async ({\n  // Absolute path to add-on XPI file.\n  xpiPath,\n  // The add-on ID as recognized by AMO. Example: my-addon@jetpack\n  id,\n  // The add-on version number for AMO.\n  version,\n  // Your API key (JWT issuer) from AMO Devhub.\n  apiKey,\n  // Your API secret (JWT secret) from AMO Devhub.\n  apiSecret,\n  // Optional arguments:\n  apiUrlPrefix = 'https://addons.mozilla.org/api/v4',\n  // Number of seconds until the JWT token for the API request expires.\n  // This must match the expiration time that the API server accepts.\n  apiJwtExpiresIn,\n  verbose = false,\n  // The release channel (listed or unlisted).\n  // Ignored for new add-ons, which are always unlisted.\n  // Defaults to most recently used channel.\n  channel,\n  // Number of milliseconds to wait before giving up on a\n  // response from Mozilla's web service.\n  timeout,\n  // Absolute directory to save downloaded files in.\n  downloadDir,\n  // Optional proxy to use for all API requests,\n  // such as \"http://yourproxy:6000\"\n  apiProxy,\n  // Optional object to pass into request() for additional configuration.\n  // Not all properties are guaranteed to be applied.\n  apiRequestConfig,\n  // Optional boolean passed to the AMO client to disable the progress bar.\n  disableProgressBar = false,\n  AMOClient = DefaultAMOClient,\n}) => {\n  /**\n   * @param {string} name\n   */\n  function reportEmpty(name) {\n    throw new Error(`required argument was empty: ${name}`);\n  }\n\n  if (!xpiPath) {\n    reportEmpty('xpiPath');\n  }\n\n  if (!version) {\n    reportEmpty('version');\n  }\n\n  if (!apiSecret) {\n    reportEmpty('apiSecret');\n  }\n\n  if (!apiKey) {\n    reportEmpty('apiKey');\n  }\n\n  try {\n    const stats = await fs.stat(xpiPath);\n\n    if (!stats.isFile) {\n      throw new Error(`not a file: ${xpiPath}`);\n    }\n  } catch (statError) {\n    throw new Error(`error with ${xpiPath}: ${statError}`);\n  }\n\n  const client = new AMOClient({\n    apiKey,\n    apiSecret,\n    apiUrlPrefix,\n    apiJwtExpiresIn,\n    downloadDir,\n    debugLogging: verbose,\n    statusCheckTimeout: timeout,\n    proxyServer: apiProxy,\n    requestConfig: apiRequestConfig,\n    disableProgressBar,\n  });\n\n  return client.sign({\n    xpiPath,\n    guid: id,\n    version,\n    channel,\n  });\n};\n\n/**\n * @param {SignAddonParams} options\n * @param {{\n *   systemProcess?: typeof process,\n *   throwError?: boolean,\n *   logger?: typeof console\n * }} extras\n * @returns {Promise<void>}\n */\nexport const signAddonAndExit = async (\n  options,\n  { systemProcess = process, throwError = false, logger = console },\n) => {\n  try {\n    const result = await signAddon(options);\n    logger.log(result.success ? 'SUCCESS' : 'FAIL');\n    systemProcess.exit(result.success ? 0 : 1);\n  } catch (/** @type {any} */ err) {\n    logger.error('FAIL');\n\n    if (throwError) {\n      throw err;\n    }\n\n    logger.error(err.stack);\n    systemProcess.exit(1);\n  }\n};\n\nexport default {\n  signAddon,\n  signAddonAndExit,\n};\n"],"mappings":"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"}