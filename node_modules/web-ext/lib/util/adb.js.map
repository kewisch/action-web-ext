{"version":3,"file":"adb.js","names":["ADBKit","isErrorWithCode","UsageError","WebExtError","createLogger","packageIdentifiers","defaultApkComponents","DEVICE_DIR_BASE","ARTIFACTS_DIR_PREFIX","defaultADB","default","log","import","meta","url","wrapADBCall","asyncFn","error","message","includes","ADBUtils","constructor","params","adb","adbBin","adbHost","adbPort","adbClient","createClient","bin","host","port","artifactsDirMap","Map","userAbortDiscovery","runShellCommand","deviceId","cmd","debug","JSON","stringify","getDevice","shell","then","util","readAll","res","toString","discoverDevices","devices","listDevices","map","dev","id","discoverInstalledFirefoxAPKs","firefoxApk","pmList","split","line","replace","trim","filter","browser","startsWith","getAndroidVersionNumber","androidVersion","androidVersionNumber","parseInt","isNaN","ensureRequiredAPKRuntimePermissions","apk","permissions","permissionsMap","perm","pmDumpLogs","amForceStopAPK","getOrCreateArtifactsDir","artifactsDir","get","Date","now","testDirOut","set","detectOrRemoveOldArtifacts","removeArtifactDirs","files","readdir","found","file","isDirectory","name","clearArtifactsDir","delete","pushFile","localPath","devicePath","push","transfer","Promise","resolve","on","startFirefoxAPK","apkComponent","deviceProfileDir","extras","key","value","component","startActivity","wait","action","category","setUserAbortDiscovery","discoverRDPUnixSocket","maxDiscoveryTime","retryInterval","rdpUnixSockets","discoveryStartedAt","msg","length","info","endsWith","setTimeout","pop","setupForward","remote","local","forward","listADBDevices","adbUtils","listADBFirefoxAPKs"],"sources":["../../src/util/adb.js"],"sourcesContent":["/* @flow */\nimport ADBKit from '@devicefarmer/adbkit';\n\nimport { isErrorWithCode, UsageError, WebExtError } from '../errors.js';\nimport { createLogger } from '../util/logger.js';\nimport packageIdentifiers, {\n  defaultApkComponents,\n} from '../firefox/package-identifiers.js';\n\nexport const DEVICE_DIR_BASE = '/data/local/tmp/';\nexport const ARTIFACTS_DIR_PREFIX = 'web-ext-artifacts-';\n\nconst defaultADB = ADBKit.default;\n\nconst log = createLogger(import.meta.url);\n\nexport type ADBUtilsParams = {|\n  adb?: typeof defaultADB,\n  // ADB configs.\n  adbBin?: string,\n  adbHost?: string,\n  adbPort?: string,\n  adbDevice?: string,\n|};\n\nexport type DiscoveryParams = {\n  maxDiscoveryTime: number,\n  retryInterval: number,\n};\n\n// Helper function used to raise an UsageError when the adb binary has not been found.\nasync function wrapADBCall(asyncFn: (...any) => Promise<any>): Promise<any> {\n  try {\n    return await asyncFn();\n  } catch (error) {\n    if (\n      isErrorWithCode('ENOENT', error) &&\n      error.message.includes('spawn adb')\n    ) {\n      throw new UsageError(\n        'No adb executable has been found. ' +\n          'You can Use --adb-bin, --adb-host/--adb-port ' +\n          'to configure it manually if needed.'\n      );\n    }\n\n    throw error;\n  }\n}\n\nexport default class ADBUtils {\n  params: ADBUtilsParams;\n  adb: typeof defaultADB;\n  adbClient: any; // TODO: better flow typing here.\n\n  // Map<deviceId -> artifactsDir>\n  artifactsDirMap: Map<string, string>;\n  // Toggled when the user wants to abort the RDP Unix Socket discovery loop\n  // while it is still executing.\n  userAbortDiscovery: boolean;\n\n  constructor(params: ADBUtilsParams) {\n    this.params = params;\n\n    const { adb, adbBin, adbHost, adbPort } = params;\n\n    this.adb = adb || defaultADB;\n\n    this.adbClient = this.adb.createClient({\n      bin: adbBin,\n      host: adbHost,\n      port: adbPort,\n    });\n\n    this.artifactsDirMap = new Map();\n\n    this.userAbortDiscovery = false;\n  }\n\n  runShellCommand(\n    deviceId: string,\n    cmd: string | Array<string>\n  ): Promise<string> {\n    const { adb, adbClient } = this;\n\n    log.debug(`Run adb shell command on ${deviceId}: ${JSON.stringify(cmd)}`);\n\n    return wrapADBCall(async () => {\n      return await adbClient\n        .getDevice(deviceId)\n        .shell(cmd)\n        .then(adb.util.readAll);\n    }).then((res) => res.toString());\n  }\n\n  async discoverDevices(): Promise<Array<string>> {\n    const { adbClient } = this;\n\n    let devices = [];\n\n    log.debug('Listing android devices');\n    devices = await wrapADBCall(async () => adbClient.listDevices());\n\n    return devices.map((dev) => dev.id);\n  }\n\n  async discoverInstalledFirefoxAPKs(\n    deviceId: string,\n    firefoxApk?: string\n  ): Promise<Array<string>> {\n    log.debug(`Listing installed Firefox APKs on ${deviceId}`);\n\n    const pmList = await this.runShellCommand(deviceId, [\n      'pm',\n      'list',\n      'packages',\n    ]);\n\n    return pmList\n      .split('\\n')\n      .map((line) => line.replace('package:', '').trim())\n      .filter((line) => {\n        // Look for an exact match if firefoxApk is defined.\n        if (firefoxApk) {\n          return line === firefoxApk;\n        }\n        // Match any package name that starts with the package name of a Firefox for Android browser.\n        for (const browser of packageIdentifiers) {\n          if (line.startsWith(browser)) {\n            return true;\n          }\n        }\n\n        return false;\n      });\n  }\n\n  async getAndroidVersionNumber(deviceId: string): Promise<number> {\n    const androidVersion = (\n      await this.runShellCommand(deviceId, ['getprop', 'ro.build.version.sdk'])\n    ).trim();\n\n    const androidVersionNumber = parseInt(androidVersion);\n\n    // No need to check the granted runtime permissions on Android versions < Lollypop.\n    if (isNaN(androidVersionNumber)) {\n      throw new WebExtError(\n        'Unable to discovery android version on ' +\n          `${deviceId}: ${androidVersion}`\n      );\n    }\n\n    return androidVersionNumber;\n  }\n\n  // Raise an UsageError when the given APK does not have the required runtime permissions.\n  async ensureRequiredAPKRuntimePermissions(\n    deviceId: string,\n    apk: string,\n    permissions: Array<string>\n  ): Promise<void> {\n    const permissionsMap = {};\n\n    // Initialize every permission to false in the permissions map.\n    for (const perm of permissions) {\n      permissionsMap[perm] = false;\n    }\n\n    // Retrieve the permissions information for the given apk.\n    const pmDumpLogs = (\n      await this.runShellCommand(deviceId, ['pm', 'dump', apk])\n    ).split('\\n');\n\n    // Set to true the required permissions that have been granted.\n    for (const line of pmDumpLogs) {\n      for (const perm of permissions) {\n        if (\n          line.includes(`${perm}: granted=true`) ||\n          line.includes(`${perm}, granted=true`)\n        ) {\n          permissionsMap[perm] = true;\n        }\n      }\n    }\n\n    for (const perm of permissions) {\n      if (!permissionsMap[perm]) {\n        throw new UsageError(\n          `Required ${perm} has not be granted for ${apk}. ` +\n            'Please grant them using the Android Settings ' +\n            'or using the following adb command:\\n' +\n            `\\t adb shell pm grant ${apk} ${perm}\\n`\n        );\n      }\n    }\n  }\n\n  async amForceStopAPK(deviceId: string, apk: string): Promise<void> {\n    await this.runShellCommand(deviceId, ['am', 'force-stop', apk]);\n  }\n\n  async getOrCreateArtifactsDir(deviceId: string): Promise<string> {\n    let artifactsDir = this.artifactsDirMap.get(deviceId);\n\n    if (artifactsDir) {\n      return artifactsDir;\n    }\n\n    artifactsDir = `${DEVICE_DIR_BASE}${ARTIFACTS_DIR_PREFIX}${Date.now()}`;\n\n    const testDirOut = (\n      await this.runShellCommand(deviceId, `test -d ${artifactsDir} ; echo $?`)\n    ).trim();\n\n    if (testDirOut !== '1') {\n      throw new WebExtError(\n        `Cannot create artifacts directory ${artifactsDir} ` +\n          `because it exists on ${deviceId}.`\n      );\n    }\n\n    await this.runShellCommand(deviceId, ['mkdir', '-p', artifactsDir]);\n\n    this.artifactsDirMap.set(deviceId, artifactsDir);\n\n    return artifactsDir;\n  }\n\n  async detectOrRemoveOldArtifacts(\n    deviceId: string,\n    removeArtifactDirs?: boolean = false\n  ): Promise<boolean> {\n    const { adbClient } = this;\n\n    log.debug('Checking adb device for existing web-ext artifacts dirs');\n\n    return wrapADBCall(async () => {\n      const files = await adbClient\n        .getDevice(deviceId)\n        .readdir(DEVICE_DIR_BASE);\n      let found = false;\n\n      for (const file of files) {\n        if (\n          !file.isDirectory() ||\n          !file.name.startsWith(ARTIFACTS_DIR_PREFIX)\n        ) {\n          continue;\n        }\n\n        // Return earlier if we only need to warn the user that some\n        // existing artifacts dirs have been found on the adb device.\n        if (!removeArtifactDirs) {\n          return true;\n        }\n\n        found = true;\n\n        const artifactsDir = `${DEVICE_DIR_BASE}${file.name}`;\n\n        log.debug(\n          `Removing artifacts directory ${artifactsDir} from device ${deviceId}`\n        );\n\n        await this.runShellCommand(deviceId, ['rm', '-rf', artifactsDir]);\n      }\n\n      return found;\n    });\n  }\n\n  async clearArtifactsDir(deviceId: string): Promise<void> {\n    const artifactsDir = this.artifactsDirMap.get(deviceId);\n\n    if (!artifactsDir) {\n      // nothing to do here.\n      return;\n    }\n\n    this.artifactsDirMap.delete(deviceId);\n\n    log.debug(\n      `Removing ${artifactsDir} artifacts directory on ${deviceId} device`\n    );\n\n    await this.runShellCommand(deviceId, ['rm', '-rf', artifactsDir]);\n  }\n\n  async pushFile(\n    deviceId: string,\n    localPath: string,\n    devicePath: string\n  ): Promise<void> {\n    const { adbClient } = this;\n\n    log.debug(`Pushing ${localPath} to ${devicePath} on ${deviceId}`);\n\n    await wrapADBCall(async () => {\n      await adbClient\n        .getDevice(deviceId)\n        .push(localPath, devicePath)\n        .then(function (transfer) {\n          return new Promise((resolve) => {\n            transfer.on('end', resolve);\n          });\n        });\n    });\n  }\n\n  async startFirefoxAPK(\n    deviceId: string,\n    apk: string,\n    apkComponent: ?string,\n    deviceProfileDir: string\n  ): Promise<void> {\n    const { adbClient } = this;\n\n    log.debug(`Starting ${apk} on ${deviceId}`);\n\n    // Fenix does ignore the -profile parameter, on the contrary Fennec\n    // would run using the given path as the profile to be used during\n    // this execution.\n    const extras = [\n      {\n        key: 'args',\n        value: `-profile ${deviceProfileDir}`,\n      },\n    ];\n\n    if (!apkComponent) {\n      apkComponent = '.App';\n      if (defaultApkComponents[apk]) {\n        apkComponent = defaultApkComponents[apk];\n      }\n    } else if (!apkComponent.includes('.')) {\n      apkComponent = `.${apkComponent}`;\n    }\n\n    // if `apk` is a browser package or the `apk` has a\n    // browser package prefix: prepend the package identifier\n    // before `apkComponent`\n    if (apkComponent.startsWith('.')) {\n      for (const browser of packageIdentifiers) {\n        if (apk === browser || apk.startsWith(`${browser}.`)) {\n          apkComponent = browser + apkComponent;\n        }\n      }\n    }\n\n    // if `apkComponent` starts with a '.', then adb will expand\n    // the following to: `${apk}/${apk}.${apkComponent}`\n    const component = `${apk}/${apkComponent}`;\n\n    await wrapADBCall(async () => {\n      try {\n        // TODO: once Fenix (release) uses Android 13, we can get rid of this\n        // call and only use the second call in the `catch` block.\n        await adbClient.getDevice(deviceId).startActivity({\n          wait: true,\n          action: 'android.activity.MAIN',\n          component,\n          extras,\n        });\n      } catch {\n        // Android 13+ requires a different action/category but we still need\n        // to support older Fenix builds.\n        await adbClient.getDevice(deviceId).startActivity({\n          wait: true,\n          action: 'android.intent.action.MAIN',\n          category: 'android.intent.category.LAUNCHER',\n          component,\n          extras,\n        });\n      }\n    });\n  }\n\n  setUserAbortDiscovery(value: boolean) {\n    this.userAbortDiscovery = value;\n  }\n\n  async discoverRDPUnixSocket(\n    deviceId: string,\n    apk: string,\n    { maxDiscoveryTime, retryInterval }: DiscoveryParams = {}\n  ): Promise<string> {\n    let rdpUnixSockets = [];\n\n    const discoveryStartedAt = Date.now();\n    const msg =\n      `Waiting for ${apk} Remote Debugging Server...` +\n      '\\nMake sure to enable \"Remote Debugging via USB\" ' +\n      'from Settings -> Developer Tools if it is not yet enabled.';\n\n    while (rdpUnixSockets.length === 0) {\n      log.info(msg);\n      if (this.userAbortDiscovery) {\n        throw new UsageError(\n          'Exiting Firefox Remote Debugging socket discovery on user request'\n        );\n      }\n\n      if (Date.now() - discoveryStartedAt > maxDiscoveryTime) {\n        throw new WebExtError(\n          'Timeout while waiting for the Android Firefox Debugger Socket'\n        );\n      }\n\n      rdpUnixSockets = (\n        await this.runShellCommand(deviceId, ['cat', '/proc/net/unix'])\n      )\n        .split('\\n')\n        .filter((line) => {\n          // The RDP unix socket is expected to be a path in the form:\n          //   /data/data/org.mozilla.fennec_rpl/firefox-debugger-socket\n          return line.trim().endsWith(`${apk}/firefox-debugger-socket`);\n        });\n\n      if (rdpUnixSockets.length === 0) {\n        await new Promise((resolve) => setTimeout(resolve, retryInterval));\n      }\n    }\n\n    // Convert into an array of unix socket filenames.\n    rdpUnixSockets = rdpUnixSockets.map((line) => {\n      return line.trim().split(/\\s/).pop();\n    });\n\n    if (rdpUnixSockets.length > 1) {\n      throw new WebExtError(\n        'Unexpected multiple RDP sockets: ' +\n          `${JSON.stringify(rdpUnixSockets)}`\n      );\n    }\n\n    return rdpUnixSockets[0];\n  }\n\n  async setupForward(deviceId: string, remote: string, local: string) {\n    const { adbClient } = this;\n\n    // TODO(rpl): we should use adb.listForwards and reuse the existing one if any (especially\n    // because adbkit doesn't seem to support `adb forward --remote` yet).\n    log.debug(`Configuring ADB forward for ${deviceId}: ${remote} -> ${local}`);\n\n    await wrapADBCall(async () => {\n      await adbClient.getDevice(deviceId).forward(local, remote);\n    });\n  }\n}\n\nexport async function listADBDevices(adbBin?: string): Promise<Array<string>> {\n  const adbUtils = new ADBUtils({ adbBin });\n  return adbUtils.discoverDevices();\n}\n\nexport async function listADBFirefoxAPKs(\n  deviceId: string,\n  adbBin?: string\n): Promise<Array<string>> {\n  const adbUtils = new ADBUtils({ adbBin });\n  return adbUtils.discoverInstalledFirefoxAPKs(deviceId);\n}\n"],"mappings":"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"}