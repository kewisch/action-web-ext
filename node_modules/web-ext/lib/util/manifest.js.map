{"version":3,"file":"manifest.js","names":["path","fs","parseJSON","stripBom","stripJsonComments","InvalidManifest","createLogger","log","import","meta","url","getValidatedManifest","sourceDir","manifestFile","join","debug","manifestContents","readFile","encoding","error","manifestData","errors","name","push","version","applications","gecko","length","getManifestId","manifestApps","browser_specific_settings","apps","id","undefined"],"sources":["../../src/util/manifest.js"],"sourcesContent":["/* @flow */\nimport path from 'path';\n\nimport {fs} from 'mz';\nimport parseJSON from 'parse-json';\nimport stripBom from 'strip-bom';\nimport stripJsonComments from 'strip-json-comments';\n\nimport {InvalidManifest} from '../errors.js';\nimport {createLogger} from './logger.js';\n\nconst log = createLogger(import.meta.url);\n\n\n// getValidatedManifest helper types and implementation\n\nexport type ExtensionManifestApplications = {|\n  gecko?: {|\n    id?: string,\n    strict_min_version?: string,\n    strict_max_version?: string,\n    update_url?: string,\n  |},\n|};\n\nexport type ExtensionManifest = {|\n  name: string,\n  version: string,\n  default_locale?: string,\n  applications?: ExtensionManifestApplications,\n  browser_specific_settings?: ExtensionManifestApplications,\n  permissions?: Array<string>,\n|};\n\nexport default async function getValidatedManifest(\n  sourceDir: string\n): Promise<ExtensionManifest> {\n  const manifestFile = path.join(sourceDir, 'manifest.json');\n  log.debug(`Validating manifest at ${manifestFile}`);\n\n  let manifestContents;\n\n  try {\n    manifestContents = await fs.readFile(manifestFile, {encoding: 'utf-8'});\n  } catch (error) {\n    throw new InvalidManifest(\n      `Could not read manifest.json file at ${manifestFile}: ${error}`);\n  }\n\n  manifestContents = stripBom(manifestContents);\n\n  let manifestData;\n\n  try {\n    manifestData = parseJSON(stripJsonComments(manifestContents));\n  } catch (error) {\n    throw new InvalidManifest(\n      `Error parsing manifest.json file at ${manifestFile}: ${error}`);\n  }\n\n  const errors = [];\n  // This is just some basic validation of what web-ext needs, not\n  // what Firefox will need to run the extension.\n  // TODO: integrate with the addons-linter for actual validation.\n  if (!manifestData.name) {\n    errors.push('missing \"name\" property');\n  }\n  if (!manifestData.version) {\n    errors.push('missing \"version\" property');\n  }\n\n  if (manifestData.applications && !manifestData.applications.gecko) {\n    // Since the applications property only applies to gecko, make\n    // sure 'gecko' exists when 'applications' is defined. This should\n    // make introspection of gecko properties easier.\n    errors.push('missing \"applications.gecko\" property');\n  }\n\n  if (errors.length) {\n    throw new InvalidManifest(\n      `Manifest at ${manifestFile} is invalid: ${errors.join('; ')}`);\n  }\n\n  return manifestData;\n}\n\n\nexport function getManifestId(manifestData: ExtensionManifest): string | void {\n  const manifestApps = [\n    manifestData.browser_specific_settings,\n    manifestData.applications,\n  ];\n  for (const apps of manifestApps) {\n    // If both bss and applicants contains a defined gecko property,\n    // we prefer bss even if the id property isn't available.\n    // This match what Firefox does in this particular scenario, see\n    // https://searchfox.org/mozilla-central/rev/828f2319c0195d7f561ed35533aef6fe183e68e3/toolkit/mozapps/extensions/internal/XPIInstall.jsm#470-474,488\n    if (apps?.gecko) {\n      return apps.gecko.id;\n    }\n  }\n\n  return undefined;\n}\n"],"mappings":"AACA,OAAOA,IAAP,MAAiB,MAAjB;AAEA,SAAQC,EAAR,QAAiB,IAAjB;AACA,OAAOC,SAAP,MAAsB,YAAtB;AACA,OAAOC,QAAP,MAAqB,WAArB;AACA,OAAOC,iBAAP,MAA8B,qBAA9B;AAEA,SAAQC,eAAR,QAA8B,cAA9B;AACA,SAAQC,YAAR,QAA2B,aAA3B;AAEA,MAAMC,GAAG,GAAGD,YAAY,CAACE,MAAM,CAACC,IAAP,CAAYC,GAAb,CAAxB,C,CAGA;;AAoBA,eAAe,eAAeC,oBAAf,CACbC,SADa,EAEe;EAC5B,MAAMC,YAAY,GAAGb,IAAI,CAACc,IAAL,CAAUF,SAAV,EAAqB,eAArB,CAArB;EACAL,GAAG,CAACQ,KAAJ,CAAW,0BAAyBF,YAAa,EAAjD;EAEA,IAAIG,gBAAJ;;EAEA,IAAI;IACFA,gBAAgB,GAAG,MAAMf,EAAE,CAACgB,QAAH,CAAYJ,YAAZ,EAA0B;MAACK,QAAQ,EAAE;IAAX,CAA1B,CAAzB;EACD,CAFD,CAEE,OAAOC,KAAP,EAAc;IACd,MAAM,IAAId,eAAJ,CACH,wCAAuCQ,YAAa,KAAIM,KAAM,EAD3D,CAAN;EAED;;EAEDH,gBAAgB,GAAGb,QAAQ,CAACa,gBAAD,CAA3B;EAEA,IAAII,YAAJ;;EAEA,IAAI;IACFA,YAAY,GAAGlB,SAAS,CAACE,iBAAiB,CAACY,gBAAD,CAAlB,CAAxB;EACD,CAFD,CAEE,OAAOG,KAAP,EAAc;IACd,MAAM,IAAId,eAAJ,CACH,uCAAsCQ,YAAa,KAAIM,KAAM,EAD1D,CAAN;EAED;;EAED,MAAME,MAAM,GAAG,EAAf,CAxB4B,CAyB5B;EACA;EACA;;EACA,IAAI,CAACD,YAAY,CAACE,IAAlB,EAAwB;IACtBD,MAAM,CAACE,IAAP,CAAY,yBAAZ;EACD;;EACD,IAAI,CAACH,YAAY,CAACI,OAAlB,EAA2B;IACzBH,MAAM,CAACE,IAAP,CAAY,4BAAZ;EACD;;EAED,IAAIH,YAAY,CAACK,YAAb,IAA6B,CAACL,YAAY,CAACK,YAAb,CAA0BC,KAA5D,EAAmE;IACjE;IACA;IACA;IACAL,MAAM,CAACE,IAAP,CAAY,uCAAZ;EACD;;EAED,IAAIF,MAAM,CAACM,MAAX,EAAmB;IACjB,MAAM,IAAItB,eAAJ,CACH,eAAcQ,YAAa,gBAAeQ,MAAM,CAACP,IAAP,CAAY,IAAZ,CAAkB,EADzD,CAAN;EAED;;EAED,OAAOM,YAAP;AACD;AAGD,OAAO,SAASQ,aAAT,CAAuBR,YAAvB,EAAuE;EAC5E,MAAMS,YAAY,GAAG,CACnBT,YAAY,CAACU,yBADM,EAEnBV,YAAY,CAACK,YAFM,CAArB;;EAIA,KAAK,MAAMM,IAAX,IAAmBF,YAAnB,EAAiC;IAC/B;IACA;IACA;IACA;IACA,IAAIE,IAAJ,aAAIA,IAAJ,eAAIA,IAAI,CAAEL,KAAV,EAAiB;MACf,OAAOK,IAAI,CAACL,KAAL,CAAWM,EAAlB;IACD;EACF;;EAED,OAAOC,SAAP;AACD"}