{"version":3,"file":"logger.js","names":["fileURLToPath","bunyan","nameFromLevel","createLogger","defaultLogCreator","ConsoleStream","constructor","verbose","isCapturing","capturedMessages","format","name","msg","level","prefix","makeVerbose","write","packet","localProcess","process","thisLevel","TRACE","INFO","push","stdout","startCapturing","stopCapturing","flushCapturedLogs","consoleStream","moduleURL","createBunyanLog","replace","streams","type","stream"],"sources":["../../src/util/logger.js"],"sourcesContent":["/* @flow */\nimport { fileURLToPath } from 'url';\n\nimport bunyan, {nameFromLevel, createLogger as defaultLogCreator}\n  from 'bunyan';\n\n// Bunyan-related Flow types\n\nexport type TRACE = 10;\nexport type DEBUG = 20;\nexport type INFO = 30;\nexport type WARN = 40;\nexport type ERROR = 50;\nexport type FATAL = 60;\n\nexport type BunyanLogLevel =\n  TRACE | DEBUG | INFO | WARN | ERROR | FATAL;\n\nexport type BunyanLogEntry = {|\n  name: string,\n  msg: string,\n  level: BunyanLogLevel,\n|};\n\nexport type Logger = {\n  debug: (msg: string, ...args: any) => void,\n  error: (msg: string, ...args: any) => void,\n  info: (msg: string, ...args: any) => void,\n  warn: (msg: string, ...args: any) => void,\n};\n\n\n// ConsoleStream types and implementation.\n\nexport type ConsoleStreamParams = {\n  verbose?: boolean,\n};\n\nexport type ConsoleOptions = {\n  localProcess?: typeof process,\n};\n\nexport class ConsoleStream {\n  verbose: boolean;\n  isCapturing: boolean;\n  capturedMessages: Array<string>;\n\n  constructor({verbose = false}: ConsoleStreamParams = {}) {\n    this.verbose = verbose;\n    this.isCapturing = false;\n    this.capturedMessages = [];\n  }\n\n  format({name, msg, level}: BunyanLogEntry): string {\n    const prefix = this.verbose ? `[${name}][${nameFromLevel[level]}] ` : '';\n    return `${prefix}${msg}\\n`;\n  }\n\n  makeVerbose() {\n    this.verbose = true;\n  }\n\n  write(\n    packet: BunyanLogEntry,\n    {localProcess = process}: ConsoleOptions = {}\n  ): void {\n    const thisLevel: BunyanLogLevel = this.verbose ? bunyan.TRACE : bunyan.INFO;\n    if (packet.level >= thisLevel) {\n      const msg = this.format(packet);\n      if (this.isCapturing) {\n        this.capturedMessages.push(msg);\n      } else {\n        localProcess.stdout.write(msg);\n      }\n    }\n  }\n\n  startCapturing() {\n    this.isCapturing = true;\n  }\n\n  stopCapturing() {\n    this.isCapturing = false;\n    this.capturedMessages = [];\n  }\n\n  flushCapturedLogs({localProcess = process}: ConsoleOptions = {}) {\n    for (const msg of this.capturedMessages) {\n      localProcess.stdout.write(msg);\n    }\n    this.capturedMessages = [];\n  }\n}\n\nexport const consoleStream: ConsoleStream = new ConsoleStream();\n\n\n// createLogger types and implementation.\n\nexport type BunyanStreamConfig = {\n  type: string,\n  stream: ConsoleStream,\n};\n\nexport type CreateBunyanLogParams = {\n  name: string,\n  level: BunyanLogLevel,\n  streams: Array<BunyanStreamConfig>,\n};\n\nexport type CreateBunyanLogFn = (params: CreateBunyanLogParams) => Logger;\n\nexport type CreateLoggerOptions = {\n  createBunyanLog: CreateBunyanLogFn,\n};\n\nexport function createLogger(\n  moduleURL?: string,\n  {createBunyanLog = defaultLogCreator}: CreateLoggerOptions = {}\n): Logger {\n  return createBunyanLog({\n    // Strip the leading src/ from file names (which is in all file names) to\n    // make the name less redundant.\n    name: moduleURL\n      ? fileURLToPath(moduleURL).replace(/^src\\//, '')\n      : 'unknown-module',\n    // Capture all log levels and let the stream filter them.\n    level: bunyan.TRACE,\n    streams: [{\n      type: 'raw',\n      stream: consoleStream,\n    }],\n  });\n}\n"],"mappings":"AACA,SAASA,aAAT,QAA8B,KAA9B;AAEA,OAAOC,MAAP,IAAgBC,aAAhB,EAA+BC,YAAY,IAAIC,iBAA/C,QACO,QADP,C,CAGA;;AAoCA,OAAO,MAAMC,aAAN,CAAoB;EAKzBC,WAAW,CAAC;IAACC,OAAO,GAAG;EAAX,IAAyC,EAA1C,EAA8C;IACvD,KAAKA,OAAL,GAAeA,OAAf;IACA,KAAKC,WAAL,GAAmB,KAAnB;IACA,KAAKC,gBAAL,GAAwB,EAAxB;EACD;;EAEDC,MAAM,CAAC;IAACC,IAAD;IAAOC,GAAP;IAAYC;EAAZ,CAAD,EAA6C;IACjD,MAAMC,MAAM,GAAG,KAAKP,OAAL,GAAgB,IAAGI,IAAK,KAAIT,aAAa,CAACW,KAAD,CAAQ,IAAjD,GAAuD,EAAtE;IACA,OAAQ,GAAEC,MAAO,GAAEF,GAAI,IAAvB;EACD;;EAEDG,WAAW,GAAG;IACZ,KAAKR,OAAL,GAAe,IAAf;EACD;;EAEDS,KAAK,CACHC,MADG,EAEH;IAACC,YAAY,GAAGC;EAAhB,IAA2C,EAFxC,EAGG;IACN,MAAMC,SAAyB,GAAG,KAAKb,OAAL,GAAeN,MAAM,CAACoB,KAAtB,GAA8BpB,MAAM,CAACqB,IAAvE;;IACA,IAAIL,MAAM,CAACJ,KAAP,IAAgBO,SAApB,EAA+B;MAC7B,MAAMR,GAAG,GAAG,KAAKF,MAAL,CAAYO,MAAZ,CAAZ;;MACA,IAAI,KAAKT,WAAT,EAAsB;QACpB,KAAKC,gBAAL,CAAsBc,IAAtB,CAA2BX,GAA3B;MACD,CAFD,MAEO;QACLM,YAAY,CAACM,MAAb,CAAoBR,KAApB,CAA0BJ,GAA1B;MACD;IACF;EACF;;EAEDa,cAAc,GAAG;IACf,KAAKjB,WAAL,GAAmB,IAAnB;EACD;;EAEDkB,aAAa,GAAG;IACd,KAAKlB,WAAL,GAAmB,KAAnB;IACA,KAAKC,gBAAL,GAAwB,EAAxB;EACD;;EAEDkB,iBAAiB,CAAC;IAACT,YAAY,GAAGC;EAAhB,IAA2C,EAA5C,EAAgD;IAC/D,KAAK,MAAMP,GAAX,IAAkB,KAAKH,gBAAvB,EAAyC;MACvCS,YAAY,CAACM,MAAb,CAAoBR,KAApB,CAA0BJ,GAA1B;IACD;;IACD,KAAKH,gBAAL,GAAwB,EAAxB;EACD;;AAjDwB;AAoD3B,OAAO,MAAMmB,aAA4B,GAAG,IAAIvB,aAAJ,EAArC,C,CAGP;;AAmBA,OAAO,SAASF,YAAT,CACL0B,SADK,EAEL;EAACC,eAAe,GAAG1B;AAAnB,IAA6D,EAFxD,EAGG;EACR,OAAO0B,eAAe,CAAC;IACrB;IACA;IACAnB,IAAI,EAAEkB,SAAS,GACX7B,aAAa,CAAC6B,SAAD,CAAb,CAAyBE,OAAzB,CAAiC,QAAjC,EAA2C,EAA3C,CADW,GAEX,gBALiB;IAMrB;IACAlB,KAAK,EAAEZ,MAAM,CAACoB,KAPO;IAQrBW,OAAO,EAAE,CAAC;MACRC,IAAI,EAAE,KADE;MAERC,MAAM,EAAEN;IAFA,CAAD;EARY,CAAD,CAAtB;AAaD"}