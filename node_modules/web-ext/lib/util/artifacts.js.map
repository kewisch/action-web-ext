{"version":3,"file":"artifacts.js","names":["fs","UsageError","isErrorWithCode","createLogger","log","import","meta","url","defaultAsyncFsAccess","access","bind","prepareArtifactsDir","artifactsDir","asyncMkdirp","dirPath","mkdir","recursive","asyncFsAccess","stats","stat","isDirectory","constants","W_OK","accessErr","error","debug","mkdirErr"],"sources":["../../src/util/artifacts.js"],"sourcesContent":["import fs from 'fs/promises';\n\nimport { UsageError, isErrorWithCode } from '../errors.js';\nimport { createLogger } from './logger.js';\n\nconst log = createLogger(import.meta.url);\n\nconst defaultAsyncFsAccess = fs.access.bind(fs);\n\nexport async function prepareArtifactsDir(\n  artifactsDir,\n  {\n    asyncMkdirp = (dirPath) => fs.mkdir(dirPath, { recursive: true }),\n    asyncFsAccess = defaultAsyncFsAccess,\n  } = {},\n) {\n  try {\n    const stats = await fs.stat(artifactsDir);\n    if (!stats.isDirectory()) {\n      throw new UsageError(\n        `--artifacts-dir=\"${artifactsDir}\" exists but it is not a directory.`,\n      );\n    }\n    // If the artifactsDir already exists, check that we have the write permissions on it.\n    try {\n      await asyncFsAccess(artifactsDir, fs.constants.W_OK);\n    } catch (accessErr) {\n      if (isErrorWithCode('EACCES', accessErr)) {\n        throw new UsageError(\n          `--artifacts-dir=\"${artifactsDir}\" exists but the user lacks ` +\n            'permissions on it.',\n        );\n      } else {\n        throw accessErr;\n      }\n    }\n  } catch (error) {\n    if (isErrorWithCode('EACCES', error)) {\n      // Handle errors when the artifactsDir cannot be accessed.\n      throw new UsageError(\n        `Cannot access --artifacts-dir=\"${artifactsDir}\" because the user ` +\n          `lacks permissions: ${error}`,\n      );\n    } else if (isErrorWithCode('ENOENT', error)) {\n      // Create the artifact dir if it doesn't exist yet.\n      try {\n        log.debug(`Creating artifacts directory: ${artifactsDir}`);\n        await asyncMkdirp(artifactsDir);\n      } catch (mkdirErr) {\n        if (isErrorWithCode('EACCES', mkdirErr)) {\n          // Handle errors when the artifactsDir cannot be created for lack of permissions.\n          throw new UsageError(\n            `Cannot create --artifacts-dir=\"${artifactsDir}\" because the ` +\n              `user lacks permissions: ${mkdirErr}`,\n          );\n        } else {\n          throw mkdirErr;\n        }\n      }\n    } else {\n      throw error;\n    }\n  }\n\n  return artifactsDir;\n}\n"],"mappings":"AAAA,OAAOA,EAAE,MAAM,aAAa;AAE5B,SAASC,UAAU,EAAEC,eAAe,QAAQ,cAAc;AAC1D,SAASC,YAAY,QAAQ,aAAa;AAE1C,MAAMC,GAAG,GAAGD,YAAY,CAACE,MAAM,CAACC,IAAI,CAACC,GAAG,CAAC;AAEzC,MAAMC,oBAAoB,GAAGR,EAAE,CAACS,MAAM,CAACC,IAAI,CAACV,EAAE,CAAC;AAE/C,OAAO,eAAeW,mBAAmBA,CACvCC,YAAY,EACZ;EACEC,WAAW,GAAIC,OAAO,IAAKd,EAAE,CAACe,KAAK,CAACD,OAAO,EAAE;IAAEE,SAAS,EAAE;EAAK,CAAC,CAAC;EACjEC,aAAa,GAAGT;AAClB,CAAC,GAAG,CAAC,CAAC,EACN;EACA,IAAI;IACF,MAAMU,KAAK,GAAG,MAAMlB,EAAE,CAACmB,IAAI,CAACP,YAAY,CAAC;IACzC,IAAI,CAACM,KAAK,CAACE,WAAW,CAAC,CAAC,EAAE;MACxB,MAAM,IAAInB,UAAU,CAClB,oBAAoBW,YAAY,qCAClC,CAAC;IACH;IACA;IACA,IAAI;MACF,MAAMK,aAAa,CAACL,YAAY,EAAEZ,EAAE,CAACqB,SAAS,CAACC,IAAI,CAAC;IACtD,CAAC,CAAC,OAAOC,SAAS,EAAE;MAClB,IAAIrB,eAAe,CAAC,QAAQ,EAAEqB,SAAS,CAAC,EAAE;QACxC,MAAM,IAAItB,UAAU,CAClB,oBAAoBW,YAAY,8BAA8B,GAC5D,oBACJ,CAAC;MACH,CAAC,MAAM;QACL,MAAMW,SAAS;MACjB;IACF;EACF,CAAC,CAAC,OAAOC,KAAK,EAAE;IACd,IAAItB,eAAe,CAAC,QAAQ,EAAEsB,KAAK,CAAC,EAAE;MACpC;MACA,MAAM,IAAIvB,UAAU,CAClB,kCAAkCW,YAAY,qBAAqB,GACjE,sBAAsBY,KAAK,EAC/B,CAAC;IACH,CAAC,MAAM,IAAItB,eAAe,CAAC,QAAQ,EAAEsB,KAAK,CAAC,EAAE;MAC3C;MACA,IAAI;QACFpB,GAAG,CAACqB,KAAK,CAAC,iCAAiCb,YAAY,EAAE,CAAC;QAC1D,MAAMC,WAAW,CAACD,YAAY,CAAC;MACjC,CAAC,CAAC,OAAOc,QAAQ,EAAE;QACjB,IAAIxB,eAAe,CAAC,QAAQ,EAAEwB,QAAQ,CAAC,EAAE;UACvC;UACA,MAAM,IAAIzB,UAAU,CAClB,kCAAkCW,YAAY,gBAAgB,GAC5D,2BAA2Bc,QAAQ,EACvC,CAAC;QACH,CAAC,MAAM;UACL,MAAMA,QAAQ;QAChB;MACF;IACF,CAAC,MAAM;MACL,MAAMF,KAAK;IACb;EACF;EAEA,OAAOZ,YAAY;AACrB","ignoreList":[]}