{"version":3,"file":"remote.js","names":["net","FirefoxRDPClient","connectToFirefox","defaultFirefoxConnector","createLogger","isErrorWithCode","RemoteTempInstallNotSupported","UsageError","WebExtError","log","import","meta","url","requestErrorToMessage","err","Error","String","error","message","RemoteFirefox","constructor","client","checkedForAddonReloading","on","debug","info","JSON","stringify","rdpError","disconnect","addonRequest","addon","request","response","to","actor","type","getAddonsActor","addonsActor","Promise","reject","installTemporaryAddon","addonPath","getInstalledAddon","addonId","addons","id","map","a","checkForAddonReloading","requestTypes","indexOf","supportedRequestTypes","reloadAddon","process","stdout","write","Date","toTimeString","connect","port","connectWithMaxRetries","maxRetries","retryInterval","establishConnection","lastError","retries","resolve","setTimeout","stack","findFreeTcpPort","srv","createServer","listen","freeTcpPort","address","close"],"sources":["../../src/firefox/remote.js"],"sourcesContent":["/* @flow */\nimport net from 'net';\n\nimport FirefoxRDPClient, {\n  connectToFirefox as defaultFirefoxConnector,\n} from './rdp-client.js';\nimport {createLogger} from '../util/logger.js';\nimport {\n  isErrorWithCode,\n  RemoteTempInstallNotSupported,\n  UsageError,\n  WebExtError,\n} from '../errors.js';\n\nconst log = createLogger(import.meta.url);\n\nexport type FirefoxConnectorFn =\n  (port: number) => Promise<FirefoxRDPClient>;\n\nexport type FirefoxRDPAddonActor = {|\n  id: string,\n  actor: string,\n|};\n\nexport type FirefoxRDPResponseError = {|\n  error: string,\n  message: string,\n|};\n\nexport type FirefoxRDPResponseAddon = {|\n  addon: FirefoxRDPAddonActor,\n|};\n\nexport type FirefoxRDPResponseRequestTypes = {|\n  requestTypes: Array<string>,\n|};\n\n// NOTE: this type aliases Object to catch any other possible response.\nexport type FirefoxRDPResponseAny = Object;\n\nexport type FirefoxRDPResponseMaybe =\n  FirefoxRDPResponseRequestTypes | FirefoxRDPResponseAny;\n\n// Convert a request rejection to a message string.\nfunction requestErrorToMessage(err: Error | FirefoxRDPResponseError) {\n  if (err instanceof Error) {\n    return String(err);\n  }\n  return `${err.error}: ${err.message}`;\n}\n\nexport class RemoteFirefox {\n  client: Object;\n  checkedForAddonReloading: boolean;\n\n  constructor(client: FirefoxRDPClient) {\n    this.client = client;\n    this.checkedForAddonReloading = false;\n\n    client.on('disconnect', () => {\n      log.debug('Received \"disconnect\" from Firefox client');\n    });\n    client.on('end', () => {\n      log.debug('Received \"end\" from Firefox client');\n    });\n    client.on('unsolicited-event', (info) => {\n      log.debug(`Received message from client: ${JSON.stringify(info)}`);\n    });\n    client.on('rdp-error', (rdpError) => {\n      log.debug(`Received error from client: ${JSON.stringify(rdpError)}`);\n    });\n    client.on('error', (error) => {\n      log.debug(`Received error from client: ${String(error)}`);\n    });\n  }\n\n  disconnect() {\n    this.client.disconnect();\n  }\n\n  async addonRequest(\n    addon: FirefoxRDPAddonActor,\n    request: string\n  ): Promise<FirefoxRDPResponseMaybe> {\n    try {\n      const response = await this.client.request({\n        to: addon.actor, type: request,\n      });\n      return response;\n    } catch (err) {\n      log.debug(\n        `Client responded to '${request}' request with error:`, err);\n      const message = requestErrorToMessage(err);\n      throw new WebExtError(`Remote Firefox: addonRequest() error: ${message}`);\n    }\n  }\n\n  async getAddonsActor(): Promise<string> {\n    try {\n      // getRoot should work since Firefox 55 (bug 1352157).\n      const response = await this.client.request('getRoot');\n      if (response.addonsActor == null) {\n        return Promise.reject(new RemoteTempInstallNotSupported(\n          'This version of Firefox does not provide an add-ons actor for ' +\n          'remote installation.'));\n      }\n      return response.addonsActor;\n    } catch (err) {\n      // Fallback to listTabs otherwise, Firefox 49 - 77 (bug 1618691).\n      log.debug('Falling back to listTabs because getRoot failed', err);\n    }\n\n    try {\n      const response = await this.client.request('listTabs');\n      // addonsActor was added to listTabs in Firefox 49 (bug 1273183).\n      if (response.addonsActor == null) {\n        log.debug(\n          'listTabs returned a falsey addonsActor: ' +\n          `${JSON.stringify(response)}`);\n        return Promise.reject(new RemoteTempInstallNotSupported(\n          'This is an older version of Firefox that does not provide an ' +\n          'add-ons actor for remote installation. Try Firefox 49 or ' +\n          'higher.'));\n      }\n      return response.addonsActor;\n    } catch (err) {\n      log.debug('listTabs error', err);\n      const message = requestErrorToMessage(err);\n      throw new WebExtError(`Remote Firefox: listTabs() error: ${message}`);\n    }\n  }\n\n  async installTemporaryAddon(\n    addonPath: string\n  ): Promise<FirefoxRDPResponseAddon> {\n    const addonsActor = await this.getAddonsActor();\n\n    try {\n      const response = await this.client.request({\n        to: addonsActor,\n        type: 'installTemporaryAddon',\n        addonPath,\n      });\n      log.debug(`installTemporaryAddon: ${JSON.stringify(response)}`);\n      log.info(`Installed ${addonPath} as a temporary add-on`);\n      return response;\n    } catch (err) {\n      const message = requestErrorToMessage(err);\n      throw new WebExtError(`installTemporaryAddon: Error: ${message}`);\n    }\n  }\n\n  async getInstalledAddon(addonId: string): Promise<FirefoxRDPAddonActor> {\n    try {\n      const response = await this.client.request('listAddons');\n      for (const addon of response.addons) {\n        if (addon.id === addonId) {\n          return addon;\n        }\n      }\n      log.debug(\n        `Remote Firefox has these addons: ${response.addons.map((a) => a.id)}`);\n      return Promise.reject(new WebExtError(\n        'The remote Firefox does not have your extension installed'));\n    } catch (err) {\n      const message = requestErrorToMessage(err);\n      throw new WebExtError(`Remote Firefox: listAddons() error: ${message}`);\n    }\n  }\n\n  async checkForAddonReloading(\n    addon: FirefoxRDPAddonActor\n  ): Promise<FirefoxRDPAddonActor> {\n    if (this.checkedForAddonReloading) {\n      // We only need to check once if reload() is supported.\n      return addon;\n    } else {\n      const response = await this.addonRequest(addon, 'requestTypes');\n\n      if (response.requestTypes.indexOf('reload') === -1) {\n        const supportedRequestTypes = JSON.stringify(response.requestTypes);\n        log.debug(\n          `Remote Firefox only supports: ${supportedRequestTypes}`);\n        throw new UsageError(\n          'This Firefox version does not support add-on reloading. ' +\n          'Re-run with --no-reload');\n      } else {\n        this.checkedForAddonReloading = true;\n        return addon;\n      }\n    }\n  }\n\n  async reloadAddon(addonId: string): Promise<void> {\n    const addon = await this.getInstalledAddon(addonId);\n    await this.checkForAddonReloading(addon);\n    await this.addonRequest(addon, 'reload');\n    process.stdout.write(\n      `\\rLast extension reload: ${(new Date()).toTimeString()}`);\n    log.debug('\\n');\n  }\n}\n\n\n// Connect types and implementation\n\nexport type ConnectOptions = {\n  connectToFirefox: FirefoxConnectorFn,\n};\n\nexport async function connect(\n  port: number,\n  {connectToFirefox = defaultFirefoxConnector}: ConnectOptions = {}\n): Promise<RemoteFirefox> {\n  log.debug(`Connecting to Firefox on port ${port}`);\n  const client = await connectToFirefox(port);\n  log.debug(`Connected to the remote Firefox debugger on port ${port}`);\n  return new RemoteFirefox(client);\n}\n\n\n// ConnectWithMaxRetries types and implementation\n\nexport type ConnectWithMaxRetriesParams = {|\n  maxRetries?: number,\n  retryInterval?: number,\n  port: number,\n|};\n\nexport type ConnectWithMaxRetriesDeps = {\n  connectToFirefox: typeof connect,\n};\n\nexport async function connectWithMaxRetries(\n  // A max of 250 will try connecting for 30 seconds.\n  {maxRetries = 250, retryInterval = 120, port}: ConnectWithMaxRetriesParams,\n  {connectToFirefox = connect}: ConnectWithMaxRetriesDeps = {}\n): Promise<RemoteFirefox> {\n  async function establishConnection() {\n    var lastError;\n\n    for (let retries = 0; retries <= maxRetries; retries++) {\n      try {\n        return await connectToFirefox(port);\n      } catch (error) {\n        if (isErrorWithCode('ECONNREFUSED', error)) {\n          // Wait for `retryInterval` ms.\n          await new Promise((resolve) => {\n            setTimeout(resolve, retryInterval);\n          });\n\n          lastError = error;\n          log.debug(\n            `Retrying Firefox (${retries}); connection error: ${error}`);\n        } else {\n          log.error(error.stack);\n          throw error;\n        }\n      }\n    }\n\n    log.debug('Connect to Firefox debugger: too many retries');\n    throw lastError;\n  }\n\n  log.debug('Connecting to the remote Firefox debugger');\n  return establishConnection();\n}\n\nexport function findFreeTcpPort(): Promise<number> {\n  return new Promise((resolve) => {\n    const srv = net.createServer();\n    // $FlowFixMe: signature for listen() is missing - see https://github.com/facebook/flow/pull/8290\n    srv.listen(0, '127.0.0.1', () => {\n      const freeTcpPort = srv.address().port;\n      srv.close(() => resolve(freeTcpPort));\n    });\n  });\n}\n"],"mappings":"AACA,OAAOA,GAAP,MAAgB,KAAhB;AAEA,OAAOC,gBAAP,IACEC,gBAAgB,IAAIC,uBADtB,QAEO,iBAFP;AAGA,SAAQC,YAAR,QAA2B,mBAA3B;AACA,SACEC,eADF,EAEEC,6BAFF,EAGEC,UAHF,EAIEC,WAJF,QAKO,cALP;AAOA,MAAMC,GAAG,GAAGL,YAAY,CAACM,MAAM,CAACC,IAAP,CAAYC,GAAb,CAAxB;;AA6BA;AACA,SAASC,qBAAT,CAA+BC,GAA/B,EAAqE;EACnE,IAAIA,GAAG,YAAYC,KAAnB,EAA0B;IACxB,OAAOC,MAAM,CAACF,GAAD,CAAb;EACD;;EACD,OAAQ,GAAEA,GAAG,CAACG,KAAM,KAAIH,GAAG,CAACI,OAAQ,EAApC;AACD;;AAED,OAAO,MAAMC,aAAN,CAAoB;EAIzBC,WAAW,CAACC,MAAD,EAA2B;IACpC,KAAKA,MAAL,GAAcA,MAAd;IACA,KAAKC,wBAAL,GAAgC,KAAhC;IAEAD,MAAM,CAACE,EAAP,CAAU,YAAV,EAAwB,MAAM;MAC5Bd,GAAG,CAACe,KAAJ,CAAU,2CAAV;IACD,CAFD;IAGAH,MAAM,CAACE,EAAP,CAAU,KAAV,EAAiB,MAAM;MACrBd,GAAG,CAACe,KAAJ,CAAU,oCAAV;IACD,CAFD;IAGAH,MAAM,CAACE,EAAP,CAAU,mBAAV,EAAgCE,IAAD,IAAU;MACvChB,GAAG,CAACe,KAAJ,CAAW,iCAAgCE,IAAI,CAACC,SAAL,CAAeF,IAAf,CAAqB,EAAhE;IACD,CAFD;IAGAJ,MAAM,CAACE,EAAP,CAAU,WAAV,EAAwBK,QAAD,IAAc;MACnCnB,GAAG,CAACe,KAAJ,CAAW,+BAA8BE,IAAI,CAACC,SAAL,CAAeC,QAAf,CAAyB,EAAlE;IACD,CAFD;IAGAP,MAAM,CAACE,EAAP,CAAU,OAAV,EAAoBN,KAAD,IAAW;MAC5BR,GAAG,CAACe,KAAJ,CAAW,+BAA8BR,MAAM,CAACC,KAAD,CAAQ,EAAvD;IACD,CAFD;EAGD;;EAEDY,UAAU,GAAG;IACX,KAAKR,MAAL,CAAYQ,UAAZ;EACD;;EAEiB,MAAZC,YAAY,CAChBC,KADgB,EAEhBC,OAFgB,EAGkB;IAClC,IAAI;MACF,MAAMC,QAAQ,GAAG,MAAM,KAAKZ,MAAL,CAAYW,OAAZ,CAAoB;QACzCE,EAAE,EAAEH,KAAK,CAACI,KAD+B;QACxBC,IAAI,EAAEJ;MADkB,CAApB,CAAvB;MAGA,OAAOC,QAAP;IACD,CALD,CAKE,OAAOnB,GAAP,EAAY;MACZL,GAAG,CAACe,KAAJ,CACG,wBAAuBQ,OAAQ,uBADlC,EAC0DlB,GAD1D;MAEA,MAAMI,OAAO,GAAGL,qBAAqB,CAACC,GAAD,CAArC;MACA,MAAM,IAAIN,WAAJ,CAAiB,yCAAwCU,OAAQ,EAAjE,CAAN;IACD;EACF;;EAEmB,MAAdmB,cAAc,GAAoB;IACtC,IAAI;MACF;MACA,MAAMJ,QAAQ,GAAG,MAAM,KAAKZ,MAAL,CAAYW,OAAZ,CAAoB,SAApB,CAAvB;;MACA,IAAIC,QAAQ,CAACK,WAAT,IAAwB,IAA5B,EAAkC;QAChC,OAAOC,OAAO,CAACC,MAAR,CAAe,IAAIlC,6BAAJ,CACpB,mEACA,sBAFoB,CAAf,CAAP;MAGD;;MACD,OAAO2B,QAAQ,CAACK,WAAhB;IACD,CATD,CASE,OAAOxB,GAAP,EAAY;MACZ;MACAL,GAAG,CAACe,KAAJ,CAAU,iDAAV,EAA6DV,GAA7D;IACD;;IAED,IAAI;MACF,MAAMmB,QAAQ,GAAG,MAAM,KAAKZ,MAAL,CAAYW,OAAZ,CAAoB,UAApB,CAAvB,CADE,CAEF;;MACA,IAAIC,QAAQ,CAACK,WAAT,IAAwB,IAA5B,EAAkC;QAChC7B,GAAG,CAACe,KAAJ,CACE,6CACC,GAAEE,IAAI,CAACC,SAAL,CAAeM,QAAf,CAAyB,EAF9B;QAGA,OAAOM,OAAO,CAACC,MAAR,CAAe,IAAIlC,6BAAJ,CACpB,kEACA,2DADA,GAEA,SAHoB,CAAf,CAAP;MAID;;MACD,OAAO2B,QAAQ,CAACK,WAAhB;IACD,CAbD,CAaE,OAAOxB,GAAP,EAAY;MACZL,GAAG,CAACe,KAAJ,CAAU,gBAAV,EAA4BV,GAA5B;MACA,MAAMI,OAAO,GAAGL,qBAAqB,CAACC,GAAD,CAArC;MACA,MAAM,IAAIN,WAAJ,CAAiB,qCAAoCU,OAAQ,EAA7D,CAAN;IACD;EACF;;EAE0B,MAArBuB,qBAAqB,CACzBC,SADyB,EAES;IAClC,MAAMJ,WAAW,GAAG,MAAM,KAAKD,cAAL,EAA1B;;IAEA,IAAI;MACF,MAAMJ,QAAQ,GAAG,MAAM,KAAKZ,MAAL,CAAYW,OAAZ,CAAoB;QACzCE,EAAE,EAAEI,WADqC;QAEzCF,IAAI,EAAE,uBAFmC;QAGzCM;MAHyC,CAApB,CAAvB;MAKAjC,GAAG,CAACe,KAAJ,CAAW,0BAAyBE,IAAI,CAACC,SAAL,CAAeM,QAAf,CAAyB,EAA7D;MACAxB,GAAG,CAACgB,IAAJ,CAAU,aAAYiB,SAAU,wBAAhC;MACA,OAAOT,QAAP;IACD,CATD,CASE,OAAOnB,GAAP,EAAY;MACZ,MAAMI,OAAO,GAAGL,qBAAqB,CAACC,GAAD,CAArC;MACA,MAAM,IAAIN,WAAJ,CAAiB,iCAAgCU,OAAQ,EAAzD,CAAN;IACD;EACF;;EAEsB,MAAjByB,iBAAiB,CAACC,OAAD,EAAiD;IACtE,IAAI;MACF,MAAMX,QAAQ,GAAG,MAAM,KAAKZ,MAAL,CAAYW,OAAZ,CAAoB,YAApB,CAAvB;;MACA,KAAK,MAAMD,KAAX,IAAoBE,QAAQ,CAACY,MAA7B,EAAqC;QACnC,IAAId,KAAK,CAACe,EAAN,KAAaF,OAAjB,EAA0B;UACxB,OAAOb,KAAP;QACD;MACF;;MACDtB,GAAG,CAACe,KAAJ,CACG,oCAAmCS,QAAQ,CAACY,MAAT,CAAgBE,GAAhB,CAAqBC,CAAD,IAAOA,CAAC,CAACF,EAA7B,CAAiC,EADvE;MAEA,OAAOP,OAAO,CAACC,MAAR,CAAe,IAAIhC,WAAJ,CACpB,2DADoB,CAAf,CAAP;IAED,CAXD,CAWE,OAAOM,GAAP,EAAY;MACZ,MAAMI,OAAO,GAAGL,qBAAqB,CAACC,GAAD,CAArC;MACA,MAAM,IAAIN,WAAJ,CAAiB,uCAAsCU,OAAQ,EAA/D,CAAN;IACD;EACF;;EAE2B,MAAtB+B,sBAAsB,CAC1BlB,KAD0B,EAEK;IAC/B,IAAI,KAAKT,wBAAT,EAAmC;MACjC;MACA,OAAOS,KAAP;IACD,CAHD,MAGO;MACL,MAAME,QAAQ,GAAG,MAAM,KAAKH,YAAL,CAAkBC,KAAlB,EAAyB,cAAzB,CAAvB;;MAEA,IAAIE,QAAQ,CAACiB,YAAT,CAAsBC,OAAtB,CAA8B,QAA9B,MAA4C,CAAC,CAAjD,EAAoD;QAClD,MAAMC,qBAAqB,GAAG1B,IAAI,CAACC,SAAL,CAAeM,QAAQ,CAACiB,YAAxB,CAA9B;QACAzC,GAAG,CAACe,KAAJ,CACG,iCAAgC4B,qBAAsB,EADzD;QAEA,MAAM,IAAI7C,UAAJ,CACJ,6DACA,yBAFI,CAAN;MAGD,CAPD,MAOO;QACL,KAAKe,wBAAL,GAAgC,IAAhC;QACA,OAAOS,KAAP;MACD;IACF;EACF;;EAEgB,MAAXsB,WAAW,CAACT,OAAD,EAAiC;IAChD,MAAMb,KAAK,GAAG,MAAM,KAAKY,iBAAL,CAAuBC,OAAvB,CAApB;IACA,MAAM,KAAKK,sBAAL,CAA4BlB,KAA5B,CAAN;IACA,MAAM,KAAKD,YAAL,CAAkBC,KAAlB,EAAyB,QAAzB,CAAN;IACAuB,OAAO,CAACC,MAAR,CAAeC,KAAf,CACG,4BAA4B,IAAIC,IAAJ,EAAD,CAAaC,YAAb,EAA4B,EAD1D;IAEAjD,GAAG,CAACe,KAAJ,CAAU,IAAV;EACD;;AArJwB,C,CAyJ3B;;AAMA,OAAO,eAAemC,OAAf,CACLC,IADK,EAEL;EAAC1D,gBAAgB,GAAGC;AAApB,IAA+D,EAF1D,EAGmB;EACxBM,GAAG,CAACe,KAAJ,CAAW,iCAAgCoC,IAAK,EAAhD;EACA,MAAMvC,MAAM,GAAG,MAAMnB,gBAAgB,CAAC0D,IAAD,CAArC;EACAnD,GAAG,CAACe,KAAJ,CAAW,oDAAmDoC,IAAK,EAAnE;EACA,OAAO,IAAIzC,aAAJ,CAAkBE,MAAlB,CAAP;AACD,C,CAGD;;AAYA,OAAO,eAAewC,qBAAf,EACL;AACA;EAACC,UAAU,GAAG,GAAd;EAAmBC,aAAa,GAAG,GAAnC;EAAwCH;AAAxC,CAFK,EAGL;EAAC1D,gBAAgB,GAAGyD;AAApB,IAA0D,EAHrD,EAImB;EACxB,eAAeK,mBAAf,GAAqC;IACnC,IAAIC,SAAJ;;IAEA,KAAK,IAAIC,OAAO,GAAG,CAAnB,EAAsBA,OAAO,IAAIJ,UAAjC,EAA6CI,OAAO,EAApD,EAAwD;MACtD,IAAI;QACF,OAAO,MAAMhE,gBAAgB,CAAC0D,IAAD,CAA7B;MACD,CAFD,CAEE,OAAO3C,KAAP,EAAc;QACd,IAAIZ,eAAe,CAAC,cAAD,EAAiBY,KAAjB,CAAnB,EAA4C;UAC1C;UACA,MAAM,IAAIsB,OAAJ,CAAa4B,OAAD,IAAa;YAC7BC,UAAU,CAACD,OAAD,EAAUJ,aAAV,CAAV;UACD,CAFK,CAAN;UAIAE,SAAS,GAAGhD,KAAZ;UACAR,GAAG,CAACe,KAAJ,CACG,qBAAoB0C,OAAQ,wBAAuBjD,KAAM,EAD5D;QAED,CATD,MASO;UACLR,GAAG,CAACQ,KAAJ,CAAUA,KAAK,CAACoD,KAAhB;UACA,MAAMpD,KAAN;QACD;MACF;IACF;;IAEDR,GAAG,CAACe,KAAJ,CAAU,+CAAV;IACA,MAAMyC,SAAN;EACD;;EAEDxD,GAAG,CAACe,KAAJ,CAAU,2CAAV;EACA,OAAOwC,mBAAmB,EAA1B;AACD;AAED,OAAO,SAASM,eAAT,GAA4C;EACjD,OAAO,IAAI/B,OAAJ,CAAa4B,OAAD,IAAa;IAC9B,MAAMI,GAAG,GAAGvE,GAAG,CAACwE,YAAJ,EAAZ,CAD8B,CAE9B;;IACAD,GAAG,CAACE,MAAJ,CAAW,CAAX,EAAc,WAAd,EAA2B,MAAM;MAC/B,MAAMC,WAAW,GAAGH,GAAG,CAACI,OAAJ,GAAcf,IAAlC;MACAW,GAAG,CAACK,KAAJ,CAAU,MAAMT,OAAO,CAACO,WAAD,CAAvB;IACD,CAHD;EAID,CAPM,CAAP;AAQD"}