{"version":3,"file":"firefox-desktop.js","names":["MultiExtensionsReloadError","RemoteTempInstallNotSupported","WebExtError","createLogger","log","import","meta","url","FirefoxDesktopExtensionRunner","cleanupCallbacks","params","profile","reloadableExtensions","remoteFirefox","runningInfo","constructor","Map","Set","getName","run","setupProfileDir","startFirefoxInstance","reloadAllExtensions","runnerName","reloadErrors","sourceDir","extensions","res","reloadExtensionBySourceDir","reloadError","Error","set","size","extensionSourceDir","addonId","get","reloadAddon","error","registerCleanup","fn","add","exit","firefox","kill","customPrefs","keepProfileChanges","preInstall","profilePath","firefoxApp","debug","useProfile","copyProfile","createProfile","extension","installExtension","asProxy","extensionPath","manifestData","browserConsole","devtools","firefoxBinary","startUrl","firefoxClient","args","binaryArgs","push","urls","Array","isArray","on","cleanupCb","port","debuggerPort","installTemporaryAddon","then","installResult","addon","id","String"],"sources":["../../src/extension-runners/firefox-desktop.js"],"sourcesContent":["/**\n * This module provide an ExtensionRunner subclass that manage an extension executed\n * in a Firefox for Desktop instance.\n */\n\nimport {\n  MultiExtensionsReloadError,\n  RemoteTempInstallNotSupported,\n  WebExtError,\n} from '../errors.js';\nimport { createLogger } from '../util/logger.js';\n\nconst log = createLogger(import.meta.url);\n\n/**\n * Implements an IExtensionRunner which manages a Firefox Desktop instance.\n */\nexport class FirefoxDesktopExtensionRunner {\n  cleanupCallbacks;\n  params;\n  profile;\n  // Map extensions sourceDir to their related addon ids.\n  reloadableExtensions;\n  remoteFirefox;\n  runningInfo;\n\n  constructor(params) {\n    this.params = params;\n\n    this.reloadableExtensions = new Map();\n    this.cleanupCallbacks = new Set();\n  }\n\n  // Method exported from the IExtensionRunner interface.\n\n  /**\n   * Returns the runner name.\n   */\n  getName() {\n    return 'Firefox Desktop';\n  }\n\n  /**\n   * Setup the Firefox Profile and run a Firefox Desktop instance.\n   */\n  async run() {\n    // Get a firefox profile with the custom Prefs set (a new or a cloned one).\n    // Pre-install extensions as proxy if needed (and disable auto-reload if you do)\n    await this.setupProfileDir();\n\n    // (if reload is enabled):\n    // - Connect to the firefox instance on RDP\n    // - Install any extension if needed (if not installed as proxy)\n    // - Keep track of the extension id assigned in a map with the sourceDir as a key\n    await this.startFirefoxInstance();\n  }\n\n  /**\n   * Reloads all the extensions, collect any reload error and resolves to\n   * an array composed by a single ExtensionRunnerReloadResult object.\n   */\n  async reloadAllExtensions() {\n    const runnerName = this.getName();\n    const reloadErrors = new Map();\n    for (const { sourceDir } of this.params.extensions) {\n      const [res] = await this.reloadExtensionBySourceDir(sourceDir);\n      if (res.reloadError instanceof Error) {\n        reloadErrors.set(sourceDir, res.reloadError);\n      }\n    }\n\n    if (reloadErrors.size > 0) {\n      return [\n        {\n          runnerName,\n          reloadError: new MultiExtensionsReloadError(reloadErrors),\n        },\n      ];\n    }\n\n    return [{ runnerName }];\n  }\n\n  /**\n   * Reloads a single extension, collect any reload error and resolves to\n   * an array composed by a single ExtensionRunnerReloadResult object.\n   */\n  async reloadExtensionBySourceDir(extensionSourceDir) {\n    const runnerName = this.getName();\n    const addonId = this.reloadableExtensions.get(extensionSourceDir);\n\n    if (!addonId) {\n      return [\n        {\n          sourceDir: extensionSourceDir,\n          reloadError: new WebExtError(\n            'Extension not reloadable: ' +\n              `no addonId has been mapped to \"${extensionSourceDir}\"`,\n          ),\n          runnerName,\n        },\n      ];\n    }\n\n    try {\n      await this.remoteFirefox.reloadAddon(addonId);\n    } catch (error) {\n      return [\n        {\n          sourceDir: extensionSourceDir,\n          reloadError: error,\n          runnerName,\n        },\n      ];\n    }\n\n    return [{ runnerName, sourceDir: extensionSourceDir }];\n  }\n\n  /**\n   * Register a callback to be called when the runner has been exited\n   * (e.g. the Firefox instance exits or the user has requested web-ext\n   * to exit).\n   */\n  registerCleanup(fn) {\n    this.cleanupCallbacks.add(fn);\n  }\n\n  /**\n   * Exits the runner, by closing the managed Firefox instance.\n   */\n  async exit() {\n    if (!this.runningInfo || !this.runningInfo.firefox) {\n      throw new WebExtError('No firefox instance is currently running');\n    }\n\n    this.runningInfo.firefox.kill();\n  }\n\n  // Private helper methods.\n\n  async setupProfileDir() {\n    const {\n      customPrefs,\n      extensions,\n      keepProfileChanges,\n      preInstall,\n      profilePath,\n      firefoxApp,\n    } = this.params;\n\n    if (profilePath) {\n      if (keepProfileChanges) {\n        log.debug(`Using Firefox profile from ${profilePath}`);\n        this.profile = await firefoxApp.useProfile(profilePath, {\n          customPrefs,\n        });\n      } else {\n        log.debug(`Copying Firefox profile from ${profilePath}`);\n        this.profile = await firefoxApp.copyProfile(profilePath, {\n          customPrefs,\n        });\n      }\n    } else {\n      log.debug('Creating new Firefox profile');\n      this.profile = await firefoxApp.createProfile({ customPrefs });\n    }\n\n    // preInstall the extensions if needed.\n    if (preInstall) {\n      for (const extension of extensions) {\n        await firefoxApp.installExtension({\n          asProxy: true,\n          extensionPath: extension.sourceDir,\n          manifestData: extension.manifestData,\n          profile: this.profile,\n        });\n      }\n    }\n  }\n\n  async startFirefoxInstance() {\n    const {\n      browserConsole,\n      devtools,\n      extensions,\n      firefoxBinary,\n      preInstall,\n      startUrl,\n      firefoxApp,\n      firefoxClient,\n      args,\n    } = this.params;\n\n    const binaryArgs = [];\n\n    if (browserConsole) {\n      binaryArgs.push('-jsconsole');\n    }\n    if (startUrl) {\n      const urls = Array.isArray(startUrl) ? startUrl : [startUrl];\n      for (const url of urls) {\n        binaryArgs.push('--url', url);\n      }\n    }\n\n    if (args) {\n      binaryArgs.push(...args);\n    }\n\n    this.runningInfo = await firefoxApp.run(this.profile, {\n      firefoxBinary,\n      binaryArgs,\n      extensions,\n      devtools,\n    });\n\n    this.runningInfo.firefox.on('close', () => {\n      for (const cleanupCb of this.cleanupCallbacks) {\n        try {\n          cleanupCb();\n        } catch (error) {\n          log.error(`Exception on executing cleanup callback: ${error}`);\n        }\n      }\n    });\n\n    if (!preInstall) {\n      const remoteFirefox = (this.remoteFirefox = await firefoxClient({\n        port: this.runningInfo.debuggerPort,\n      }));\n\n      // Install all the temporary addons.\n      for (const extension of extensions) {\n        try {\n          const addonId = await remoteFirefox\n            .installTemporaryAddon(extension.sourceDir, devtools)\n            .then((installResult) => {\n              return installResult.addon.id;\n            });\n\n          if (!addonId) {\n            throw new WebExtError(\n              'Unexpected missing addonId in the installAsTemporaryAddon result',\n            );\n          }\n\n          this.reloadableExtensions.set(extension.sourceDir, addonId);\n        } catch (error) {\n          if (error instanceof RemoteTempInstallNotSupported) {\n            log.debug(`Caught: ${String(error)}`);\n            throw new WebExtError(\n              'Temporary add-on installation is not supported in this version' +\n                ' of Firefox (you need Firefox 49 or higher). For older Firefox' +\n                ' versions, use --pre-install',\n            );\n          } else {\n            throw error;\n          }\n        }\n      }\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}