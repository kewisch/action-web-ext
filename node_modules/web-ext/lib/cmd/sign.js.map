{"version":3,"file":"sign.js","names":["path","defaultBuilder","isErrorWithCode","UsageError","WebExtError","prepareArtifactsDir","createLogger","getValidatedManifest","getManifestId","defaultAsyncFsReadFile","signAddon","defaultSubmitAddonSigner","withTempDir","log","import","meta","url","extensionIdFile","uploadUuidFile","sign","amoBaseUrl","apiKey","apiProxy","apiSecret","artifactsDir","ignoreFiles","sourceDir","timeout","approvalTimeout","channel","amoMetadata","uploadSourceCode","webextVersion","build","preValidatedManifest","submitAddon","asyncFsReadFile","tmpDir","manifestData","savedIdPath","join","savedUploadUuidPath","buildResult","idFromSourceDir","Promise","all","showReadyMessage","getIdFromFile","id","manifest_version","warn","metaDataJson","metadataFileBuffer","JSON","parse","toString","err","userAgentString","signSubmitArgs","xpiPath","extensionPath","downloadDir","result","validationCheckTimeout","approvalCheckTimeout","undefined","submissionSource","clientError","message","filePath","content","error","debug","lines","split","filter","line","trim","startsWith"],"sources":["../../src/cmd/sign.js"],"sourcesContent":["import path from 'path';\n\nimport defaultBuilder from './build.js';\nimport { isErrorWithCode, UsageError, WebExtError } from '../errors.js';\nimport { prepareArtifactsDir } from '../util/artifacts.js';\nimport { createLogger } from '../util/logger.js';\nimport getValidatedManifest, { getManifestId } from '../util/manifest.js';\nimport {\n  defaultAsyncFsReadFile,\n  signAddon as defaultSubmitAddonSigner,\n} from '../util/submit-addon.js';\nimport { withTempDir } from '../util/temp-dir.js';\n\nconst log = createLogger(import.meta.url);\n\nexport const extensionIdFile = '.web-extension-id';\nexport const uploadUuidFile = '.amo-upload-uuid';\n\n// Sign command types and implementation.\n\nexport default function sign(\n  {\n    amoBaseUrl,\n    apiKey,\n    apiProxy,\n    apiSecret,\n    artifactsDir,\n    ignoreFiles = [],\n    sourceDir,\n    timeout,\n    approvalTimeout,\n    channel,\n    amoMetadata,\n    uploadSourceCode,\n    webextVersion,\n  },\n  {\n    build = defaultBuilder,\n    preValidatedManifest,\n    submitAddon = defaultSubmitAddonSigner,\n    asyncFsReadFile = defaultAsyncFsReadFile,\n  } = {},\n) {\n  return withTempDir(async function (tmpDir) {\n    await prepareArtifactsDir(artifactsDir);\n\n    let manifestData;\n    const savedIdPath = path.join(sourceDir, extensionIdFile);\n    const savedUploadUuidPath = path.join(sourceDir, uploadUuidFile);\n\n    if (preValidatedManifest) {\n      manifestData = preValidatedManifest;\n    } else {\n      manifestData = await getValidatedManifest(sourceDir);\n    }\n\n    const [buildResult, idFromSourceDir] = await Promise.all([\n      build(\n        { sourceDir, ignoreFiles, artifactsDir: tmpDir.path() },\n        { manifestData, showReadyMessage: false },\n      ),\n      getIdFromFile(savedIdPath),\n    ]);\n\n    const id = getManifestId(manifestData);\n    if (idFromSourceDir && !id) {\n      throw new UsageError(\n        'Cannot use previously auto-generated extension ID ' +\n          `${idFromSourceDir} - This extension ID must be specified in the manifest.json file.`,\n      );\n    }\n\n    if (!id) {\n      // We only auto-generate add-on IDs for MV2 add-ons on AMO.\n      if (manifestData.manifest_version !== 2) {\n        throw new UsageError(\n          'An extension ID must be specified in the manifest.json file.',\n        );\n      }\n\n      log.warn(\n        'No extension ID specified (it will be auto-generated the first time)',\n      );\n    }\n\n    if (!channel) {\n      throw new UsageError('You must specify a channel');\n    }\n\n    let metaDataJson;\n    if (amoMetadata) {\n      const metadataFileBuffer = await asyncFsReadFile(amoMetadata);\n      try {\n        metaDataJson = JSON.parse(metadataFileBuffer.toString());\n      } catch (err) {\n        throw new UsageError('Invalid JSON in listing metadata');\n      }\n    }\n    const userAgentString = `web-ext/${webextVersion}`;\n\n    const signSubmitArgs = {\n      apiKey,\n      apiSecret,\n      apiProxy,\n      id,\n      xpiPath: buildResult.extensionPath,\n      downloadDir: artifactsDir,\n      channel,\n    };\n\n    try {\n      const result = await submitAddon({\n        ...signSubmitArgs,\n        amoBaseUrl,\n        channel,\n        savedIdPath,\n        savedUploadUuidPath,\n        metaDataJson,\n        userAgentString,\n        validationCheckTimeout: timeout,\n        approvalCheckTimeout:\n          approvalTimeout !== undefined ? approvalTimeout : timeout,\n        submissionSource: uploadSourceCode,\n      });\n\n      return result;\n    } catch (clientError) {\n      throw new WebExtError(clientError.message);\n    }\n  });\n}\n\nexport async function getIdFromFile(\n  filePath,\n  asyncFsReadFile = defaultAsyncFsReadFile,\n) {\n  let content;\n\n  try {\n    content = await asyncFsReadFile(filePath);\n  } catch (error) {\n    if (isErrorWithCode('ENOENT', error)) {\n      log.debug(`No ID file found at: ${filePath}`);\n      return;\n    }\n    throw error;\n  }\n\n  let lines = content.toString().split('\\n');\n  lines = lines.filter((line) => {\n    line = line.trim();\n    if (line && !line.startsWith('#')) {\n      return line;\n    }\n  });\n\n  const id = lines[0];\n  log.debug(`Found extension ID ${id} in ${filePath}`);\n\n  if (!id) {\n    throw new UsageError(`No ID found in extension ID file ${filePath}`);\n  }\n\n  return id;\n}\n"],"mappings":"AAAA,OAAOA,IAAI,MAAM,MAAM;AAEvB,OAAOC,cAAc,MAAM,YAAY;AACvC,SAASC,eAAe,EAAEC,UAAU,EAAEC,WAAW,QAAQ,cAAc;AACvE,SAASC,mBAAmB,QAAQ,sBAAsB;AAC1D,SAASC,YAAY,QAAQ,mBAAmB;AAChD,OAAOC,oBAAoB,IAAIC,aAAa,QAAQ,qBAAqB;AACzE,SACEC,sBAAsB,EACtBC,SAAS,IAAIC,wBAAwB,QAChC,yBAAyB;AAChC,SAASC,WAAW,QAAQ,qBAAqB;AAEjD,MAAMC,GAAG,GAAGP,YAAY,CAACQ,MAAM,CAACC,IAAI,CAACC,GAAG,CAAC;AAEzC,OAAO,MAAMC,eAAe,GAAG,mBAAmB;AAClD,OAAO,MAAMC,cAAc,GAAG,kBAAkB;;AAEhD;;AAEA,eAAe,SAASC,IAAIA,CAC1B;EACEC,UAAU;EACVC,MAAM;EACNC,QAAQ;EACRC,SAAS;EACTC,YAAY;EACZC,WAAW,GAAG,EAAE;EAChBC,SAAS;EACTC,OAAO;EACPC,eAAe;EACfC,OAAO;EACPC,WAAW;EACXC,gBAAgB;EAChBC;AACF,CAAC,EACD;EACEC,KAAK,GAAGhC,cAAc;EACtBiC,oBAAoB;EACpBC,WAAW,GAAGxB,wBAAwB;EACtCyB,eAAe,GAAG3B;AACpB,CAAC,GAAG,CAAC,CAAC,EACN;EACA,OAAOG,WAAW,CAAC,gBAAgByB,MAAM,EAAE;IACzC,MAAMhC,mBAAmB,CAACmB,YAAY,CAAC;IAEvC,IAAIc,YAAY;IAChB,MAAMC,WAAW,GAAGvC,IAAI,CAACwC,IAAI,CAACd,SAAS,EAAET,eAAe,CAAC;IACzD,MAAMwB,mBAAmB,GAAGzC,IAAI,CAACwC,IAAI,CAACd,SAAS,EAAER,cAAc,CAAC;IAEhE,IAAIgB,oBAAoB,EAAE;MACxBI,YAAY,GAAGJ,oBAAoB;IACrC,CAAC,MAAM;MACLI,YAAY,GAAG,MAAM/B,oBAAoB,CAACmB,SAAS,CAAC;IACtD;IAEA,MAAM,CAACgB,WAAW,EAAEC,eAAe,CAAC,GAAG,MAAMC,OAAO,CAACC,GAAG,CAAC,CACvDZ,KAAK,CACH;MAAEP,SAAS;MAAED,WAAW;MAAED,YAAY,EAAEa,MAAM,CAACrC,IAAI,CAAC;IAAE,CAAC,EACvD;MAAEsC,YAAY;MAAEQ,gBAAgB,EAAE;IAAM,CAC1C,CAAC,EACDC,aAAa,CAACR,WAAW,CAAC,CAC3B,CAAC;IAEF,MAAMS,EAAE,GAAGxC,aAAa,CAAC8B,YAAY,CAAC;IACtC,IAAIK,eAAe,IAAI,CAACK,EAAE,EAAE;MAC1B,MAAM,IAAI7C,UAAU,CAClB,oDAAoD,GAClD,GAAGwC,eAAe,mEACtB,CAAC;IACH;IAEA,IAAI,CAACK,EAAE,EAAE;MACP;MACA,IAAIV,YAAY,CAACW,gBAAgB,KAAK,CAAC,EAAE;QACvC,MAAM,IAAI9C,UAAU,CAClB,8DACF,CAAC;MACH;MAEAU,GAAG,CAACqC,IAAI,CACN,sEACF,CAAC;IACH;IAEA,IAAI,CAACrB,OAAO,EAAE;MACZ,MAAM,IAAI1B,UAAU,CAAC,4BAA4B,CAAC;IACpD;IAEA,IAAIgD,YAAY;IAChB,IAAIrB,WAAW,EAAE;MACf,MAAMsB,kBAAkB,GAAG,MAAMhB,eAAe,CAACN,WAAW,CAAC;MAC7D,IAAI;QACFqB,YAAY,GAAGE,IAAI,CAACC,KAAK,CAACF,kBAAkB,CAACG,QAAQ,CAAC,CAAC,CAAC;MAC1D,CAAC,CAAC,OAAOC,GAAG,EAAE;QACZ,MAAM,IAAIrD,UAAU,CAAC,kCAAkC,CAAC;MAC1D;IACF;IACA,MAAMsD,eAAe,GAAG,WAAWzB,aAAa,EAAE;IAElD,MAAM0B,cAAc,GAAG;MACrBrC,MAAM;MACNE,SAAS;MACTD,QAAQ;MACR0B,EAAE;MACFW,OAAO,EAAEjB,WAAW,CAACkB,aAAa;MAClCC,WAAW,EAAErC,YAAY;MACzBK;IACF,CAAC;IAED,IAAI;MACF,MAAMiC,MAAM,GAAG,MAAM3B,WAAW,CAAC;QAC/B,GAAGuB,cAAc;QACjBtC,UAAU;QACVS,OAAO;QACPU,WAAW;QACXE,mBAAmB;QACnBU,YAAY;QACZM,eAAe;QACfM,sBAAsB,EAAEpC,OAAO;QAC/BqC,oBAAoB,EAClBpC,eAAe,KAAKqC,SAAS,GAAGrC,eAAe,GAAGD,OAAO;QAC3DuC,gBAAgB,EAAEnC;MACpB,CAAC,CAAC;MAEF,OAAO+B,MAAM;IACf,CAAC,CAAC,OAAOK,WAAW,EAAE;MACpB,MAAM,IAAI/D,WAAW,CAAC+D,WAAW,CAACC,OAAO,CAAC;IAC5C;EACF,CAAC,CAAC;AACJ;AAEA,OAAO,eAAerB,aAAaA,CACjCsB,QAAQ,EACRjC,eAAe,GAAG3B,sBAAsB,EACxC;EACA,IAAI6D,OAAO;EAEX,IAAI;IACFA,OAAO,GAAG,MAAMlC,eAAe,CAACiC,QAAQ,CAAC;EAC3C,CAAC,CAAC,OAAOE,KAAK,EAAE;IACd,IAAIrE,eAAe,CAAC,QAAQ,EAAEqE,KAAK,CAAC,EAAE;MACpC1D,GAAG,CAAC2D,KAAK,CAAC,wBAAwBH,QAAQ,EAAE,CAAC;MAC7C;IACF;IACA,MAAME,KAAK;EACb;EAEA,IAAIE,KAAK,GAAGH,OAAO,CAACf,QAAQ,CAAC,CAAC,CAACmB,KAAK,CAAC,IAAI,CAAC;EAC1CD,KAAK,GAAGA,KAAK,CAACE,MAAM,CAAEC,IAAI,IAAK;IAC7BA,IAAI,GAAGA,IAAI,CAACC,IAAI,CAAC,CAAC;IAClB,IAAID,IAAI,IAAI,CAACA,IAAI,CAACE,UAAU,CAAC,GAAG,CAAC,EAAE;MACjC,OAAOF,IAAI;IACb;EACF,CAAC,CAAC;EAEF,MAAM5B,EAAE,GAAGyB,KAAK,CAAC,CAAC,CAAC;EACnB5D,GAAG,CAAC2D,KAAK,CAAC,sBAAsBxB,EAAE,OAAOqB,QAAQ,EAAE,CAAC;EAEpD,IAAI,CAACrB,EAAE,EAAE;IACP,MAAM,IAAI7C,UAAU,CAAC,oCAAoCkE,QAAQ,EAAE,CAAC;EACtE;EAEA,OAAOrB,EAAE;AACX","ignoreList":[]}