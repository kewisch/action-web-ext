{"version":3,"file":"run.js","names":["fs","defaultBuildExtension","showDesktopNotification","defaultDesktopNotifications","defaultFirefoxApp","connectWithMaxRetries","defaultFirefoxClient","createLogger","defaultGetValidatedManifest","UsageError","createExtensionRunner","defaultReloadStrategy","MultiExtensionRunner","DefaultMultiExtensionRunner","log","import","meta","url","run","artifactsDir","browserConsole","pref","firefox","firefoxProfile","profileCreateIfMissing","keepProfileChanges","ignoreFiles","noInput","noReload","preInstall","sourceDir","watchFile","watchIgnored","startUrl","target","args","firefoxPreview","adbBin","adbHost","adbPort","adbDevice","adbDiscoveryTimeout","adbRemoveOldArtifacts","firefoxApk","firefoxApkComponent","chromiumBinary","chromiumProfile","buildExtension","desktopNotifications","firefoxApp","firefoxClient","reloadStrategy","getValidatedManifest","info","Array","isArray","every","el","customPrefs","includes","manifestData","profileDir","isDir","existsSync","mkdir","runners","commonRunnerParams","extensions","length","firefoxDesktopRunnerParams","firefoxBinary","profilePath","firefoxDesktopRunner","params","push","firefoxAndroidRunnerParams","buildSourceDir","extensionSourceDir","tmpArtifactsDir","asNeeded","showReadyMessage","firefoxAndroidRunner","chromiumRunnerParams","chromiumRunner","extensionRunner"],"sources":["../../src/cmd/run.js"],"sourcesContent":["/* @flow */\nimport { fs } from 'mz';\n\nimport defaultBuildExtension from './build.js';\nimport {\n  showDesktopNotification as defaultDesktopNotifications,\n} from '../util/desktop-notifier.js';\nimport * as defaultFirefoxApp from '../firefox/index.js';\nimport {\n  connectWithMaxRetries as defaultFirefoxClient,\n} from '../firefox/remote.js';\nimport {createLogger} from '../util/logger.js';\nimport defaultGetValidatedManifest from '../util/manifest.js';\nimport {UsageError} from '../errors.js';\nimport {\n  createExtensionRunner,\n  defaultReloadStrategy,\n  MultiExtensionRunner as DefaultMultiExtensionRunner,\n} from '../extension-runners/index.js';\n// Import objects that are only used as Flow types.\nimport type {FirefoxPreferences} from '../firefox/preferences.js';\n\nconst log = createLogger(import.meta.url);\n\n\n// Run command types and implementation.\n\nexport type CmdRunParams = {|\n  artifactsDir: string,\n  browserConsole: boolean,\n  pref?: FirefoxPreferences,\n  firefox: string,\n  firefoxProfile?: string,\n  profileCreateIfMissing?: boolean,\n  ignoreFiles?: Array<string>,\n  keepProfileChanges: boolean,\n  noInput?: boolean,\n  noReload: boolean,\n  preInstall: boolean,\n  sourceDir: string,\n  watchFile?: Array<string>,\n  watchIgnored?: Array<string>,\n  startUrl?: Array<string>,\n  target?: Array<string>,\n  args?: Array<string>,\n  firefoxPreview: Array<string>,\n\n  // Android CLI options.\n  adbBin?: string,\n  adbHost?: string,\n  adbPort?: string,\n  adbDevice?: string,\n  adbDiscoveryTimeout?: number,\n  adbRemoveOldArtifacts?: boolean,\n  firefoxApk?: string,\n  firefoxApkComponent?: string,\n\n  // Chromium Desktop CLI options.\n  chromiumBinary?: string,\n  chromiumProfile?: string,\n|};\n\nexport type CmdRunOptions = {\n  buildExtension: typeof defaultBuildExtension,\n  desktopNotifications: typeof defaultDesktopNotifications,\n  firefoxApp: typeof defaultFirefoxApp,\n  firefoxClient: typeof defaultFirefoxClient,\n  reloadStrategy: typeof defaultReloadStrategy,\n  shouldExitProgram?: boolean,\n  MultiExtensionRunner?: typeof DefaultMultiExtensionRunner,\n  getValidatedManifest?: typeof defaultGetValidatedManifest,\n};\n\nexport default async function run(\n  {\n    artifactsDir,\n    browserConsole = false,\n    pref,\n    firefox,\n    firefoxProfile,\n    profileCreateIfMissing,\n    keepProfileChanges = false,\n    ignoreFiles,\n    noInput = false,\n    noReload = false,\n    preInstall = false,\n    sourceDir,\n    watchFile,\n    watchIgnored,\n    startUrl,\n    target,\n    args,\n    firefoxPreview = [],\n    // Android CLI options.\n    adbBin,\n    adbHost,\n    adbPort,\n    adbDevice,\n    adbDiscoveryTimeout,\n    adbRemoveOldArtifacts,\n    firefoxApk,\n    firefoxApkComponent,\n    // Chromium CLI options.\n    chromiumBinary,\n    chromiumProfile,\n  }: CmdRunParams,\n  {\n    buildExtension = defaultBuildExtension,\n    desktopNotifications = defaultDesktopNotifications,\n    firefoxApp = defaultFirefoxApp,\n    firefoxClient = defaultFirefoxClient,\n    reloadStrategy = defaultReloadStrategy,\n    MultiExtensionRunner = DefaultMultiExtensionRunner,\n    getValidatedManifest = defaultGetValidatedManifest,\n  }: CmdRunOptions = {}): Promise<DefaultMultiExtensionRunner> {\n\n  log.info(`Running web extension from ${sourceDir}`);\n  if (preInstall) {\n    log.info('Disabled auto-reloading because it\\'s not possible with ' +\n             '--pre-install');\n    noReload = true;\n  }\n\n  if (watchFile != null && (!Array.isArray(watchFile) ||\n      !watchFile.every((el) => typeof el === 'string'))) {\n    throw new UsageError('Unexpected watchFile type');\n  }\n\n  // Create an alias for --pref since it has been transformed into an\n  // object containing one or more preferences.\n  const customPrefs: FirefoxPreferences = {...pref};\n  if (firefoxPreview.includes('mv3')) {\n    log.info('Configuring Firefox preferences for Manifest V3');\n    customPrefs['extensions.manifestV3.enabled'] = true;\n  }\n\n  const manifestData = await getValidatedManifest(sourceDir);\n\n  const profileDir = firefoxProfile || chromiumProfile;\n\n  if (profileCreateIfMissing) {\n    if (!profileDir) {\n      throw new UsageError(\n        '--profile-create-if-missing requires ' +\n        '--firefox-profile or --chromium-profile'\n      );\n    }\n    const isDir = fs.existsSync(profileDir);\n    if (isDir) {\n      log.info(`Profile directory ${profileDir} already exists`);\n    } else {\n      log.info(`Profile directory not found. Creating directory ${profileDir}`);\n      await fs.mkdir(profileDir);\n    }\n  }\n\n  const runners = [];\n\n  const commonRunnerParams = {\n    // Common options.\n    extensions: [{sourceDir, manifestData}],\n    keepProfileChanges,\n    startUrl,\n    args,\n    desktopNotifications,\n  };\n\n  if (!target || target.length === 0 || target.includes('firefox-desktop')) {\n    const firefoxDesktopRunnerParams = {\n      ...commonRunnerParams,\n\n      // Firefox specific CLI options.\n      firefoxBinary: firefox,\n      profilePath: firefoxProfile,\n      customPrefs,\n      browserConsole,\n      preInstall,\n\n      // Firefox runner injected dependencies.\n      firefoxApp,\n      firefoxClient,\n    };\n\n    const firefoxDesktopRunner = await createExtensionRunner({\n      target: 'firefox-desktop',\n      params: firefoxDesktopRunnerParams,\n    });\n    runners.push(firefoxDesktopRunner);\n  }\n\n  if (target && target.includes('firefox-android')) {\n    const firefoxAndroidRunnerParams = {\n      ...commonRunnerParams,\n\n      // Firefox specific CLI options.\n      profilePath: firefoxProfile,\n      customPrefs,\n      browserConsole,\n      preInstall,\n      firefoxApk,\n      firefoxApkComponent,\n      adbDevice,\n      adbHost,\n      adbPort,\n      adbBin,\n      adbDiscoveryTimeout,\n      adbRemoveOldArtifacts,\n\n      // Injected dependencies.\n      firefoxApp,\n      firefoxClient,\n      desktopNotifications: defaultDesktopNotifications,\n      buildSourceDir: (extensionSourceDir: string, tmpArtifactsDir: string) => {\n        return buildExtension({\n          sourceDir: extensionSourceDir,\n          ignoreFiles,\n          asNeeded: false,\n          // Use a separate temporary directory for building the extension zip file\n          // that we are going to upload on the android device.\n          artifactsDir: tmpArtifactsDir,\n        }, {\n          // Suppress the message usually logged by web-ext build.\n          showReadyMessage: false,\n        });\n      },\n    };\n\n    const firefoxAndroidRunner = await createExtensionRunner({\n      target: 'firefox-android',\n      params: firefoxAndroidRunnerParams,\n    });\n    runners.push(firefoxAndroidRunner);\n  }\n\n  if (target && target.includes('chromium')) {\n    const chromiumRunnerParams = {\n      ...commonRunnerParams,\n      chromiumBinary,\n      chromiumProfile,\n    };\n\n    const chromiumRunner = await createExtensionRunner({\n      target: 'chromium',\n      params: chromiumRunnerParams,\n    });\n    runners.push(chromiumRunner);\n  }\n\n  const extensionRunner = new MultiExtensionRunner({\n    desktopNotifications,\n    runners,\n  });\n\n  await extensionRunner.run();\n\n  if (noReload) {\n    log.info('Automatic extension reloading has been disabled');\n  } else {\n    log.info('The extension will reload if any source file changes');\n\n    reloadStrategy({\n      extensionRunner,\n      sourceDir,\n      watchFile,\n      watchIgnored,\n      artifactsDir,\n      ignoreFiles,\n      noInput,\n    });\n  }\n\n  return extensionRunner;\n}\n"],"mappings":"AACA,SAASA,EAAT,QAAmB,IAAnB;AAEA,OAAOC,qBAAP,MAAkC,YAAlC;AACA,SACEC,uBAAuB,IAAIC,2BAD7B,QAEO,6BAFP;AAGA,OAAO,KAAKC,iBAAZ,MAAmC,qBAAnC;AACA,SACEC,qBAAqB,IAAIC,oBAD3B,QAEO,sBAFP;AAGA,SAAQC,YAAR,QAA2B,mBAA3B;AACA,OAAOC,2BAAP,MAAwC,qBAAxC;AACA,SAAQC,UAAR,QAAyB,cAAzB;AACA,SACEC,qBADF,EAEEC,qBAFF,EAGEC,oBAAoB,IAAIC,2BAH1B,QAIO,+BAJP,C,CAKA;;AAGA,MAAMC,GAAG,GAAGP,YAAY,CAACQ,MAAM,CAACC,IAAP,CAAYC,GAAb,CAAxB,C,CAGA;;AAgDA,eAAe,eAAeC,GAAf,CACb;EACEC,YADF;EAEEC,cAAc,GAAG,KAFnB;EAGEC,IAHF;EAIEC,OAJF;EAKEC,cALF;EAMEC,sBANF;EAOEC,kBAAkB,GAAG,KAPvB;EAQEC,WARF;EASEC,OAAO,GAAG,KATZ;EAUEC,QAAQ,GAAG,KAVb;EAWEC,UAAU,GAAG,KAXf;EAYEC,SAZF;EAaEC,SAbF;EAcEC,YAdF;EAeEC,QAfF;EAgBEC,MAhBF;EAiBEC,IAjBF;EAkBEC,cAAc,GAAG,EAlBnB;EAmBE;EACAC,MApBF;EAqBEC,OArBF;EAsBEC,OAtBF;EAuBEC,SAvBF;EAwBEC,mBAxBF;EAyBEC,qBAzBF;EA0BEC,UA1BF;EA2BEC,mBA3BF;EA4BE;EACAC,cA7BF;EA8BEC;AA9BF,CADa,EAiCb;EACEC,cAAc,GAAG9C,qBADnB;EAEE+C,oBAAoB,GAAG7C,2BAFzB;EAGE8C,UAAU,GAAG7C,iBAHf;EAIE8C,aAAa,GAAG5C,oBAJlB;EAKE6C,cAAc,GAAGxC,qBALnB;EAMEC,oBAAoB,GAAGC,2BANzB;EAOEuC,oBAAoB,GAAG5C;AAPzB,IAQmB,EAzCN,EAyCgD;EAE7DM,GAAG,CAACuC,IAAJ,CAAU,8BAA6BvB,SAAU,EAAjD;;EACA,IAAID,UAAJ,EAAgB;IACdf,GAAG,CAACuC,IAAJ,CAAS,6DACA,eADT;IAEAzB,QAAQ,GAAG,IAAX;EACD;;EAED,IAAIG,SAAS,IAAI,IAAb,KAAsB,CAACuB,KAAK,CAACC,OAAN,CAAcxB,SAAd,CAAD,IACtB,CAACA,SAAS,CAACyB,KAAV,CAAiBC,EAAD,IAAQ,OAAOA,EAAP,KAAc,QAAtC,CADD,CAAJ,EACuD;IACrD,MAAM,IAAIhD,UAAJ,CAAe,2BAAf,CAAN;EACD,CAZ4D,CAc7D;EACA;;;EACA,MAAMiD,WAA+B,GAAG,EAAC,GAAGrC;EAAJ,CAAxC;;EACA,IAAIe,cAAc,CAACuB,QAAf,CAAwB,KAAxB,CAAJ,EAAoC;IAClC7C,GAAG,CAACuC,IAAJ,CAAS,iDAAT;IACAK,WAAW,CAAC,+BAAD,CAAX,GAA+C,IAA/C;EACD;;EAED,MAAME,YAAY,GAAG,MAAMR,oBAAoB,CAACtB,SAAD,CAA/C;EAEA,MAAM+B,UAAU,GAAGtC,cAAc,IAAIuB,eAArC;;EAEA,IAAItB,sBAAJ,EAA4B;IAC1B,IAAI,CAACqC,UAAL,EAAiB;MACf,MAAM,IAAIpD,UAAJ,CACJ,0CACA,yCAFI,CAAN;IAID;;IACD,MAAMqD,KAAK,GAAG9D,EAAE,CAAC+D,UAAH,CAAcF,UAAd,CAAd;;IACA,IAAIC,KAAJ,EAAW;MACThD,GAAG,CAACuC,IAAJ,CAAU,qBAAoBQ,UAAW,iBAAzC;IACD,CAFD,MAEO;MACL/C,GAAG,CAACuC,IAAJ,CAAU,mDAAkDQ,UAAW,EAAvE;MACA,MAAM7D,EAAE,CAACgE,KAAH,CAASH,UAAT,CAAN;IACD;EACF;;EAED,MAAMI,OAAO,GAAG,EAAhB;EAEA,MAAMC,kBAAkB,GAAG;IACzB;IACAC,UAAU,EAAE,CAAC;MAACrC,SAAD;MAAY8B;IAAZ,CAAD,CAFa;IAGzBnC,kBAHyB;IAIzBQ,QAJyB;IAKzBE,IALyB;IAMzBa;EANyB,CAA3B;;EASA,IAAI,CAACd,MAAD,IAAWA,MAAM,CAACkC,MAAP,KAAkB,CAA7B,IAAkClC,MAAM,CAACyB,QAAP,CAAgB,iBAAhB,CAAtC,EAA0E;IACxE,MAAMU,0BAA0B,GAAG,EACjC,GAAGH,kBAD8B;MAGjC;MACAI,aAAa,EAAEhD,OAJkB;MAKjCiD,WAAW,EAAEhD,cALoB;MAMjCmC,WANiC;MAOjCtC,cAPiC;MAQjCS,UARiC;MAUjC;MACAoB,UAXiC;MAYjCC;IAZiC,CAAnC;IAeA,MAAMsB,oBAAoB,GAAG,MAAM9D,qBAAqB,CAAC;MACvDwB,MAAM,EAAE,iBAD+C;MAEvDuC,MAAM,EAAEJ;IAF+C,CAAD,CAAxD;IAIAJ,OAAO,CAACS,IAAR,CAAaF,oBAAb;EACD;;EAED,IAAItC,MAAM,IAAIA,MAAM,CAACyB,QAAP,CAAgB,iBAAhB,CAAd,EAAkD;IAChD,MAAMgB,0BAA0B,GAAG,EACjC,GAAGT,kBAD8B;MAGjC;MACAK,WAAW,EAAEhD,cAJoB;MAKjCmC,WALiC;MAMjCtC,cANiC;MAOjCS,UAPiC;MAQjCc,UARiC;MASjCC,mBATiC;MAUjCJ,SAViC;MAWjCF,OAXiC;MAYjCC,OAZiC;MAajCF,MAbiC;MAcjCI,mBAdiC;MAejCC,qBAfiC;MAiBjC;MACAO,UAlBiC;MAmBjCC,aAnBiC;MAoBjCF,oBAAoB,EAAE7C,2BApBW;MAqBjCyE,cAAc,EAAE,CAACC,kBAAD,EAA6BC,eAA7B,KAAyD;QACvE,OAAO/B,cAAc,CAAC;UACpBjB,SAAS,EAAE+C,kBADS;UAEpBnD,WAFoB;UAGpBqD,QAAQ,EAAE,KAHU;UAIpB;UACA;UACA5D,YAAY,EAAE2D;QANM,CAAD,EAOlB;UACD;UACAE,gBAAgB,EAAE;QAFjB,CAPkB,CAArB;MAWD;IAjCgC,CAAnC;IAoCA,MAAMC,oBAAoB,GAAG,MAAMvE,qBAAqB,CAAC;MACvDwB,MAAM,EAAE,iBAD+C;MAEvDuC,MAAM,EAAEE;IAF+C,CAAD,CAAxD;IAIAV,OAAO,CAACS,IAAR,CAAaO,oBAAb;EACD;;EAED,IAAI/C,MAAM,IAAIA,MAAM,CAACyB,QAAP,CAAgB,UAAhB,CAAd,EAA2C;IACzC,MAAMuB,oBAAoB,GAAG,EAC3B,GAAGhB,kBADwB;MAE3BrB,cAF2B;MAG3BC;IAH2B,CAA7B;IAMA,MAAMqC,cAAc,GAAG,MAAMzE,qBAAqB,CAAC;MACjDwB,MAAM,EAAE,UADyC;MAEjDuC,MAAM,EAAES;IAFyC,CAAD,CAAlD;IAIAjB,OAAO,CAACS,IAAR,CAAaS,cAAb;EACD;;EAED,MAAMC,eAAe,GAAG,IAAIxE,oBAAJ,CAAyB;IAC/CoC,oBAD+C;IAE/CiB;EAF+C,CAAzB,CAAxB;EAKA,MAAMmB,eAAe,CAAClE,GAAhB,EAAN;;EAEA,IAAIU,QAAJ,EAAc;IACZd,GAAG,CAACuC,IAAJ,CAAS,iDAAT;EACD,CAFD,MAEO;IACLvC,GAAG,CAACuC,IAAJ,CAAS,sDAAT;IAEAF,cAAc,CAAC;MACbiC,eADa;MAEbtD,SAFa;MAGbC,SAHa;MAIbC,YAJa;MAKbb,YALa;MAMbO,WANa;MAObC;IAPa,CAAD,CAAd;EASD;;EAED,OAAOyD,eAAP;AACD"}