{"version":3,"file":"build.js","names":["path","createWriteStream","fs","parseJSON","stripBom","defaultFromEvent","zipDir","defaultSourceWatcher","getValidatedManifest","getManifestId","prepareArtifactsDir","createLogger","UsageError","isErrorWithCode","createFileFilter","defaultFileFilterCreator","log","import","meta","url","DEFAULT_FILENAME_TEMPLATE","safeFileName","name","toLowerCase","replace","getDefaultLocalizedName","messageFile","manifestData","messageData","messageContents","extensionName","readFile","encoding","error","default","stripJsonComments","match","messageName","message","Promise","resolve","getStringPropertyValue","prop","obj","properties","split","value","reduce","prev","curr","includes","stringValue","length","getPackageNameFromTemplate","filenameTemplate","packageName","manifestProperty","parsed","parse","dir","ext","defaultPackageCreator","sourceDir","fileFilter","artifactsDir","overwriteDest","showReadyMessage","filename","fromEvent","id","debug","buffer","filter","args","wantFile","default_locale","join","extensionPath","stream","flags","write","end","info","overwriteStream","build","asNeeded","ignoreFiles","onSourceChange","packageCreator","rebuildAsNeeded","createPackage","result","onChange","catch","stack","shouldWatchFile"],"sources":["../../src/cmd/build.js"],"sourcesContent":["import path from 'path';\nimport { createWriteStream } from 'fs';\nimport fs from 'fs/promises';\n\nimport parseJSON from 'parse-json';\nimport stripBom from 'strip-bom';\nimport defaultFromEvent from 'promise-toolbox/fromEvent';\nimport zipDir from 'zip-dir';\n\nimport defaultSourceWatcher from '../watcher.js';\nimport getValidatedManifest, { getManifestId } from '../util/manifest.js';\nimport { prepareArtifactsDir } from '../util/artifacts.js';\nimport { createLogger } from '../util/logger.js';\nimport { UsageError, isErrorWithCode } from '../errors.js';\nimport { createFileFilter as defaultFileFilterCreator } from '../util/file-filter.js';\n\nconst log = createLogger(import.meta.url);\nconst DEFAULT_FILENAME_TEMPLATE = '{name}-{version}.zip';\n\nexport function safeFileName(name) {\n  return name.toLowerCase().replace(/[^a-z0-9.-]+/g, '_');\n}\n\n// defaultPackageCreator types and implementation.\n\n// This defines the _locales/messages.json type. See:\n// https://developer.mozilla.org/en-US/Add-ons/WebExtensions/Internationalization#Providing_localized_strings_in__locales\n\nexport async function getDefaultLocalizedName({ messageFile, manifestData }) {\n  let messageData;\n  let messageContents;\n  let extensionName = manifestData.name;\n\n  try {\n    messageContents = await fs.readFile(messageFile, { encoding: 'utf-8' });\n  } catch (error) {\n    throw new UsageError(\n      `Error reading messages.json file at ${messageFile}: ${error}`,\n    );\n  }\n\n  messageContents = stripBom(messageContents);\n\n  const { default: stripJsonComments } = await import('strip-json-comments');\n  try {\n    messageData = parseJSON(stripJsonComments(messageContents));\n  } catch (error) {\n    throw new UsageError(\n      `Error parsing messages.json file at ${messageFile}: ${error}`,\n    );\n  }\n\n  extensionName = manifestData.name.replace(\n    /__MSG_([A-Za-z0-9@_]+?)__/g,\n    (match, messageName) => {\n      if (!(messageData[messageName] && messageData[messageName].message)) {\n        const error = new UsageError(\n          `The locale file ${messageFile} ` + `is missing key: ${messageName}`,\n        );\n        throw error;\n      } else {\n        return messageData[messageName].message;\n      }\n    },\n  );\n  return Promise.resolve(extensionName);\n}\n\n// https://stackoverflow.com/a/22129960\nexport function getStringPropertyValue(prop, obj) {\n  const properties = prop.split('.');\n  const value = properties.reduce((prev, curr) => prev && prev[curr], obj);\n  if (!['string', 'number'].includes(typeof value)) {\n    throw new UsageError(\n      `Manifest key \"${prop}\" is missing or has an invalid type: ${value}`,\n    );\n  }\n  const stringValue = `${value}`;\n  if (!stringValue.length) {\n    throw new UsageError(`Manifest key \"${prop}\" value is an empty string`);\n  }\n  return stringValue;\n}\n\nfunction getPackageNameFromTemplate(filenameTemplate, manifestData) {\n  const packageName = filenameTemplate.replace(\n    /{([A-Za-z0-9._]+?)}/g,\n    (match, manifestProperty) => {\n      return safeFileName(\n        getStringPropertyValue(manifestProperty, manifestData),\n      );\n    },\n  );\n\n  // Validate the resulting packageName string, after interpolating the manifest property\n  // specified in the template string.\n  const parsed = path.parse(packageName);\n  if (parsed.dir) {\n    throw new UsageError(\n      `Invalid filename template \"${filenameTemplate}\". ` +\n        `Filename \"${packageName}\" should not contain a path`,\n    );\n  }\n  if (!['.zip', '.xpi'].includes(parsed.ext)) {\n    throw new UsageError(\n      `Invalid filename template \"${filenameTemplate}\". ` +\n        `Filename \"${packageName}\" should have a zip or xpi extension`,\n    );\n  }\n\n  return packageName;\n}\n\nexport async function defaultPackageCreator(\n  {\n    manifestData,\n    sourceDir,\n    fileFilter,\n    artifactsDir,\n    overwriteDest,\n    showReadyMessage,\n    filename = DEFAULT_FILENAME_TEMPLATE,\n  },\n  { fromEvent = defaultFromEvent } = {},\n) {\n  let id;\n  if (manifestData) {\n    id = getManifestId(manifestData);\n    log.debug(`Using manifest id=${id || '[not specified]'}`);\n  } else {\n    manifestData = await getValidatedManifest(sourceDir);\n  }\n\n  const buffer = await zipDir(sourceDir, {\n    filter: (...args) => fileFilter.wantFile(...args),\n  });\n\n  let filenameTemplate = filename;\n\n  let { default_locale } = manifestData;\n  if (default_locale) {\n    default_locale = default_locale.replace(/-/g, '_');\n    const messageFile = path.join(\n      sourceDir,\n      '_locales',\n      default_locale,\n      'messages.json',\n    );\n    log.debug('Manifest declared default_locale, localizing extension name');\n    const extensionName = await getDefaultLocalizedName({\n      messageFile,\n      manifestData,\n    });\n    // allow for a localized `{name}`, without mutating `manifestData`\n    filenameTemplate = filenameTemplate.replace(/{name}/g, extensionName);\n  }\n\n  const packageName = safeFileName(\n    getPackageNameFromTemplate(filenameTemplate, manifestData),\n  );\n  const extensionPath = path.join(artifactsDir, packageName);\n\n  // Added 'wx' flags to avoid overwriting of existing package.\n  const stream = createWriteStream(extensionPath, { flags: 'wx' });\n\n  stream.write(buffer, () => {\n    stream.end();\n  });\n\n  try {\n    await fromEvent(stream, 'close');\n  } catch (error) {\n    if (!isErrorWithCode('EEXIST', error)) {\n      throw error;\n    }\n    if (!overwriteDest) {\n      throw new UsageError(\n        `Extension exists at the destination path: ${extensionPath}\\n` +\n          'Use --overwrite-dest to enable overwriting.',\n      );\n    }\n    log.info(`Destination exists, overwriting: ${extensionPath}`);\n    const overwriteStream = createWriteStream(extensionPath);\n    overwriteStream.write(buffer, () => {\n      overwriteStream.end();\n    });\n    await fromEvent(overwriteStream, 'close');\n  }\n\n  if (showReadyMessage) {\n    log.info(`Your web extension is ready: ${extensionPath}`);\n  }\n  return { extensionPath };\n}\n\n// Build command types and implementation.\n\nexport default async function build(\n  {\n    sourceDir,\n    artifactsDir,\n    asNeeded = false,\n    overwriteDest = false,\n    ignoreFiles = [],\n    filename = DEFAULT_FILENAME_TEMPLATE,\n  },\n  {\n    manifestData,\n    createFileFilter = defaultFileFilterCreator,\n    fileFilter = createFileFilter({\n      sourceDir,\n      artifactsDir,\n      ignoreFiles,\n    }),\n    onSourceChange = defaultSourceWatcher,\n    packageCreator = defaultPackageCreator,\n    showReadyMessage = true,\n  } = {},\n) {\n  const rebuildAsNeeded = asNeeded; // alias for `build --as-needed`\n  log.info(`Building web extension from ${sourceDir}`);\n\n  const createPackage = () =>\n    packageCreator({\n      manifestData,\n      sourceDir,\n      fileFilter,\n      artifactsDir,\n      overwriteDest,\n      showReadyMessage,\n      filename,\n    });\n\n  await prepareArtifactsDir(artifactsDir);\n  const result = await createPackage();\n\n  if (rebuildAsNeeded) {\n    log.info('Rebuilding when files change...');\n    onSourceChange({\n      sourceDir,\n      artifactsDir,\n      onChange: () => {\n        return createPackage().catch((error) => {\n          log.error(error.stack);\n          throw error;\n        });\n      },\n      shouldWatchFile: (...args) => fileFilter.wantFile(...args),\n    });\n  }\n\n  return result;\n}\n"],"mappings":"AAAA,OAAOA,IAAI,MAAM,MAAM;AACvB,SAASC,iBAAiB,QAAQ,IAAI;AACtC,OAAOC,EAAE,MAAM,aAAa;AAE5B,OAAOC,SAAS,MAAM,YAAY;AAClC,OAAOC,QAAQ,MAAM,WAAW;AAChC,OAAOC,gBAAgB,MAAM,2BAA2B;AACxD,OAAOC,MAAM,MAAM,SAAS;AAE5B,OAAOC,oBAAoB,MAAM,eAAe;AAChD,OAAOC,oBAAoB,IAAIC,aAAa,QAAQ,qBAAqB;AACzE,SAASC,mBAAmB,QAAQ,sBAAsB;AAC1D,SAASC,YAAY,QAAQ,mBAAmB;AAChD,SAASC,UAAU,EAAEC,eAAe,QAAQ,cAAc;AAC1D,SAASC,gBAAgB,IAAIC,wBAAwB,QAAQ,wBAAwB;AAErF,MAAMC,GAAG,GAAGL,YAAY,CAACM,MAAM,CAACC,IAAI,CAACC,GAAG,CAAC;AACzC,MAAMC,yBAAyB,GAAG,sBAAsB;AAExD,OAAO,SAASC,YAAYA,CAACC,IAAI,EAAE;EACjC,OAAOA,IAAI,CAACC,WAAW,CAAC,CAAC,CAACC,OAAO,CAAC,eAAe,EAAE,GAAG,CAAC;AACzD;;AAEA;;AAEA;AACA;;AAEA,OAAO,eAAeC,uBAAuBA,CAAC;EAAEC,WAAW;EAAEC;AAAa,CAAC,EAAE;EAC3E,IAAIC,WAAW;EACf,IAAIC,eAAe;EACnB,IAAIC,aAAa,GAAGH,YAAY,CAACL,IAAI;EAErC,IAAI;IACFO,eAAe,GAAG,MAAM3B,EAAE,CAAC6B,QAAQ,CAACL,WAAW,EAAE;MAAEM,QAAQ,EAAE;IAAQ,CAAC,CAAC;EACzE,CAAC,CAAC,OAAOC,KAAK,EAAE;IACd,MAAM,IAAIrB,UAAU,CAClB,uCAAuCc,WAAW,KAAKO,KAAK,EAC9D,CAAC;EACH;EAEAJ,eAAe,GAAGzB,QAAQ,CAACyB,eAAe,CAAC;EAE3C,MAAM;IAAEK,OAAO,EAAEC;EAAkB,CAAC,GAAG,MAAM,MAAM,CAAC,qBAAqB,CAAC;EAC1E,IAAI;IACFP,WAAW,GAAGzB,SAAS,CAACgC,iBAAiB,CAACN,eAAe,CAAC,CAAC;EAC7D,CAAC,CAAC,OAAOI,KAAK,EAAE;IACd,MAAM,IAAIrB,UAAU,CAClB,uCAAuCc,WAAW,KAAKO,KAAK,EAC9D,CAAC;EACH;EAEAH,aAAa,GAAGH,YAAY,CAACL,IAAI,CAACE,OAAO,CACvC,4BAA4B,EAC5B,CAACY,KAAK,EAAEC,WAAW,KAAK;IACtB,IAAI,EAAET,WAAW,CAACS,WAAW,CAAC,IAAIT,WAAW,CAACS,WAAW,CAAC,CAACC,OAAO,CAAC,EAAE;MACnE,MAAML,KAAK,GAAG,IAAIrB,UAAU,CAC1B,mBAAmBc,WAAW,GAAG,GAAG,mBAAmBW,WAAW,EACpE,CAAC;MACD,MAAMJ,KAAK;IACb,CAAC,MAAM;MACL,OAAOL,WAAW,CAACS,WAAW,CAAC,CAACC,OAAO;IACzC;EACF,CACF,CAAC;EACD,OAAOC,OAAO,CAACC,OAAO,CAACV,aAAa,CAAC;AACvC;;AAEA;AACA,OAAO,SAASW,sBAAsBA,CAACC,IAAI,EAAEC,GAAG,EAAE;EAChD,MAAMC,UAAU,GAAGF,IAAI,CAACG,KAAK,CAAC,GAAG,CAAC;EAClC,MAAMC,KAAK,GAAGF,UAAU,CAACG,MAAM,CAAC,CAACC,IAAI,EAAEC,IAAI,KAAKD,IAAI,IAAIA,IAAI,CAACC,IAAI,CAAC,EAAEN,GAAG,CAAC;EACxE,IAAI,CAAC,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAACO,QAAQ,CAAC,OAAOJ,KAAK,CAAC,EAAE;IAChD,MAAM,IAAIlC,UAAU,CAClB,iBAAiB8B,IAAI,wCAAwCI,KAAK,EACpE,CAAC;EACH;EACA,MAAMK,WAAW,GAAG,GAAGL,KAAK,EAAE;EAC9B,IAAI,CAACK,WAAW,CAACC,MAAM,EAAE;IACvB,MAAM,IAAIxC,UAAU,CAAC,iBAAiB8B,IAAI,4BAA4B,CAAC;EACzE;EACA,OAAOS,WAAW;AACpB;AAEA,SAASE,0BAA0BA,CAACC,gBAAgB,EAAE3B,YAAY,EAAE;EAClE,MAAM4B,WAAW,GAAGD,gBAAgB,CAAC9B,OAAO,CAC1C,sBAAsB,EACtB,CAACY,KAAK,EAAEoB,gBAAgB,KAAK;IAC3B,OAAOnC,YAAY,CACjBoB,sBAAsB,CAACe,gBAAgB,EAAE7B,YAAY,CACvD,CAAC;EACH,CACF,CAAC;;EAED;EACA;EACA,MAAM8B,MAAM,GAAGzD,IAAI,CAAC0D,KAAK,CAACH,WAAW,CAAC;EACtC,IAAIE,MAAM,CAACE,GAAG,EAAE;IACd,MAAM,IAAI/C,UAAU,CAClB,8BAA8B0C,gBAAgB,KAAK,GACjD,aAAaC,WAAW,6BAC5B,CAAC;EACH;EACA,IAAI,CAAC,CAAC,MAAM,EAAE,MAAM,CAAC,CAACL,QAAQ,CAACO,MAAM,CAACG,GAAG,CAAC,EAAE;IAC1C,MAAM,IAAIhD,UAAU,CAClB,8BAA8B0C,gBAAgB,KAAK,GACjD,aAAaC,WAAW,sCAC5B,CAAC;EACH;EAEA,OAAOA,WAAW;AACpB;AAEA,OAAO,eAAeM,qBAAqBA,CACzC;EACElC,YAAY;EACZmC,SAAS;EACTC,UAAU;EACVC,YAAY;EACZC,aAAa;EACbC,gBAAgB;EAChBC,QAAQ,GAAG/C;AACb,CAAC,EACD;EAAEgD,SAAS,GAAG/D;AAAiB,CAAC,GAAG,CAAC,CAAC,EACrC;EACA,IAAIgE,EAAE;EACN,IAAI1C,YAAY,EAAE;IAChB0C,EAAE,GAAG5D,aAAa,CAACkB,YAAY,CAAC;IAChCX,GAAG,CAACsD,KAAK,CAAC,qBAAqBD,EAAE,IAAI,iBAAiB,EAAE,CAAC;EAC3D,CAAC,MAAM;IACL1C,YAAY,GAAG,MAAMnB,oBAAoB,CAACsD,SAAS,CAAC;EACtD;EAEA,MAAMS,MAAM,GAAG,MAAMjE,MAAM,CAACwD,SAAS,EAAE;IACrCU,MAAM,EAAEA,CAAC,GAAGC,IAAI,KAAKV,UAAU,CAACW,QAAQ,CAAC,GAAGD,IAAI;EAClD,CAAC,CAAC;EAEF,IAAInB,gBAAgB,GAAGa,QAAQ;EAE/B,IAAI;IAAEQ;EAAe,CAAC,GAAGhD,YAAY;EACrC,IAAIgD,cAAc,EAAE;IAClBA,cAAc,GAAGA,cAAc,CAACnD,OAAO,CAAC,IAAI,EAAE,GAAG,CAAC;IAClD,MAAME,WAAW,GAAG1B,IAAI,CAAC4E,IAAI,CAC3Bd,SAAS,EACT,UAAU,EACVa,cAAc,EACd,eACF,CAAC;IACD3D,GAAG,CAACsD,KAAK,CAAC,6DAA6D,CAAC;IACxE,MAAMxC,aAAa,GAAG,MAAML,uBAAuB,CAAC;MAClDC,WAAW;MACXC;IACF,CAAC,CAAC;IACF;IACA2B,gBAAgB,GAAGA,gBAAgB,CAAC9B,OAAO,CAAC,SAAS,EAAEM,aAAa,CAAC;EACvE;EAEA,MAAMyB,WAAW,GAAGlC,YAAY,CAC9BgC,0BAA0B,CAACC,gBAAgB,EAAE3B,YAAY,CAC3D,CAAC;EACD,MAAMkD,aAAa,GAAG7E,IAAI,CAAC4E,IAAI,CAACZ,YAAY,EAAET,WAAW,CAAC;;EAE1D;EACA,MAAMuB,MAAM,GAAG7E,iBAAiB,CAAC4E,aAAa,EAAE;IAAEE,KAAK,EAAE;EAAK,CAAC,CAAC;EAEhED,MAAM,CAACE,KAAK,CAACT,MAAM,EAAE,MAAM;IACzBO,MAAM,CAACG,GAAG,CAAC,CAAC;EACd,CAAC,CAAC;EAEF,IAAI;IACF,MAAMb,SAAS,CAACU,MAAM,EAAE,OAAO,CAAC;EAClC,CAAC,CAAC,OAAO7C,KAAK,EAAE;IACd,IAAI,CAACpB,eAAe,CAAC,QAAQ,EAAEoB,KAAK,CAAC,EAAE;MACrC,MAAMA,KAAK;IACb;IACA,IAAI,CAACgC,aAAa,EAAE;MAClB,MAAM,IAAIrD,UAAU,CAClB,6CAA6CiE,aAAa,IAAI,GAC5D,6CACJ,CAAC;IACH;IACA7D,GAAG,CAACkE,IAAI,CAAC,oCAAoCL,aAAa,EAAE,CAAC;IAC7D,MAAMM,eAAe,GAAGlF,iBAAiB,CAAC4E,aAAa,CAAC;IACxDM,eAAe,CAACH,KAAK,CAACT,MAAM,EAAE,MAAM;MAClCY,eAAe,CAACF,GAAG,CAAC,CAAC;IACvB,CAAC,CAAC;IACF,MAAMb,SAAS,CAACe,eAAe,EAAE,OAAO,CAAC;EAC3C;EAEA,IAAIjB,gBAAgB,EAAE;IACpBlD,GAAG,CAACkE,IAAI,CAAC,gCAAgCL,aAAa,EAAE,CAAC;EAC3D;EACA,OAAO;IAAEA;EAAc,CAAC;AAC1B;;AAEA;;AAEA,eAAe,eAAeO,KAAKA,CACjC;EACEtB,SAAS;EACTE,YAAY;EACZqB,QAAQ,GAAG,KAAK;EAChBpB,aAAa,GAAG,KAAK;EACrBqB,WAAW,GAAG,EAAE;EAChBnB,QAAQ,GAAG/C;AACb,CAAC,EACD;EACEO,YAAY;EACZb,gBAAgB,GAAGC,wBAAwB;EAC3CgD,UAAU,GAAGjD,gBAAgB,CAAC;IAC5BgD,SAAS;IACTE,YAAY;IACZsB;EACF,CAAC,CAAC;EACFC,cAAc,GAAGhF,oBAAoB;EACrCiF,cAAc,GAAG3B,qBAAqB;EACtCK,gBAAgB,GAAG;AACrB,CAAC,GAAG,CAAC,CAAC,EACN;EACA,MAAMuB,eAAe,GAAGJ,QAAQ,CAAC,CAAC;EAClCrE,GAAG,CAACkE,IAAI,CAAC,+BAA+BpB,SAAS,EAAE,CAAC;EAEpD,MAAM4B,aAAa,GAAGA,CAAA,KACpBF,cAAc,CAAC;IACb7D,YAAY;IACZmC,SAAS;IACTC,UAAU;IACVC,YAAY;IACZC,aAAa;IACbC,gBAAgB;IAChBC;EACF,CAAC,CAAC;EAEJ,MAAMzD,mBAAmB,CAACsD,YAAY,CAAC;EACvC,MAAM2B,MAAM,GAAG,MAAMD,aAAa,CAAC,CAAC;EAEpC,IAAID,eAAe,EAAE;IACnBzE,GAAG,CAACkE,IAAI,CAAC,iCAAiC,CAAC;IAC3CK,cAAc,CAAC;MACbzB,SAAS;MACTE,YAAY;MACZ4B,QAAQ,EAAEA,CAAA,KAAM;QACd,OAAOF,aAAa,CAAC,CAAC,CAACG,KAAK,CAAE5D,KAAK,IAAK;UACtCjB,GAAG,CAACiB,KAAK,CAACA,KAAK,CAAC6D,KAAK,CAAC;UACtB,MAAM7D,KAAK;QACb,CAAC,CAAC;MACJ,CAAC;MACD8D,eAAe,EAAEA,CAAC,GAAGtB,IAAI,KAAKV,UAAU,CAACW,QAAQ,CAAC,GAAGD,IAAI;IAC3D,CAAC,CAAC;EACJ;EAEA,OAAOkB,MAAM;AACf","ignoreList":[]}