name: "Build"
on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    name: "Build and Test"
    runs-on: ubuntu-latest
    env:
      HAS_AMO_SIGN_KEY: ${{ secrets.AMO_SIGN_KEY != '' && secrets.AMO_SIGN_KEY != null }}
      HAS_ATN_SIGN_KEY: ${{ secrets.ATN_SIGN_KEY != '' && secrets.ATN_SIGN_KEY != null }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "npm ci"
        run: npm ci

      - name: "Run Linters"
        run: npm run lint

      - name: "Bump version"
        run: |
          export VERSION="1.$((10#${GITHUB_RUN_ID:0:4})).$((10#${GITHUB_RUN_ID:4}))"
          jq ".version = \"$VERSION\"" test/extension/manifest.json > manifest.json~
          mv manifest.json~ test/extension/manifest.json
          git diff test/extension

      - name: "Self-test: lint"
        id: web-ext-lint
        uses: "./"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          cmd: lint
          source: test/extension
          channel: unlisted

      - name: "Self-test: build"
        id: web-ext-build
        uses: "./"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          cmd: build
          source: test/extension
          channel: unlisted

      - name: "Self-test: AMO release"
        if: env.HAS_AMO_SIGN_KEY == 'true'
        id: web-ext-sign-amo
        uses: "./"
        with:
          cmd: sign
          source: ${{ steps.web-ext-build.outputs.target }}
          channel: unlisted
          apiKey: ${{ secrets.AMO_SIGN_KEY }}
          apiSecret: ${{ secrets.AMO_SIGN_SECRET }}

      - name: "Self-test: ATN release"
        if: env.HAS_ATN_SIGN_KEY == 'true'
        id: web-ext-sign-atn
        uses: "./"
        with:
          cmd: sign
          source: ${{ steps.web-ext-build.outputs.target }}
          channel: unlisted
          apiUrlPrefix: "https://addons.thunderbird.net/api/v3"
          apiKey: ${{ secrets.ATN_SIGN_KEY }}
          apiSecret: ${{ secrets.ATN_SIGN_SECRET }}

      - name: "Upload Unsigned"
        uses: actions/upload-artifact@v4
        with:
          name: unsigned.xpi
          path: ${{ steps.web-ext-build.outputs.target }}

      - name: "Upload AMO signed"
        if: env.HAS_AMO_SIGN_KEY == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: amo-signed.xpi
          path: ${{ steps.web-ext-sign-amo.outputs.target }}
